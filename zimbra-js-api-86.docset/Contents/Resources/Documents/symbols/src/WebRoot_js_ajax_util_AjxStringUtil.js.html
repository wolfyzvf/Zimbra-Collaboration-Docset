<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class="line">  1</span> <span class="COMM">/*
<span class="line">  2</span>  * ***** BEGIN LICENSE BLOCK *****
<span class="line">  3</span>  * Zimbra Collaboration Suite Web Client
<span class="line">  4</span>  * Copyright (C) 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014 Zimbra, Inc.
<span class="line">  5</span>  * 
<span class="line">  6</span>  * The contents of this file are subject to the Common Public Attribution License Version 1.0 (the &#34;License&#34;);
<span class="line">  7</span>  * you may not use this file except in compliance with the License. 
<span class="line">  8</span>  * You may obtain a copy of the License at: http://www.zimbra.com/license
<span class="line">  9</span>  * The License is based on the Mozilla Public License Version 1.1 but Sections 14 and 15 
<span class="line"> 10</span>  * have been added to cover use of software over a computer network and provide for limited attribution 
<span class="line"> 11</span>  * for the Original Developer. In addition, Exhibit A has been modified to be consistent with Exhibit B. 
<span class="line"> 12</span>  * 
<span class="line"> 13</span>  * Software distributed under the License is distributed on an &#34;AS IS&#34; basis, 
<span class="line"> 14</span>  * WITHOUT WARRANTY OF ANY KIND, either express or implied. 
<span class="line"> 15</span>  * See the License for the specific language governing rights and limitations under the License. 
<span class="line"> 16</span>  * The Original Code is Zimbra Open Source Web Client. 
<span class="line"> 17</span>  * The Initial Developer of the Original Code is Zimbra, Inc. 
<span class="line"> 18</span>  * All portions of the code are Copyright (C) 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014 Zimbra, Inc. All Rights Reserved. 
<span class="line"> 19</span>  * ***** END LICENSE BLOCK *****
<span class="line"> 20</span>  */</span><span class="WHIT">
<span class="line"> 21</span> 
<span class="line"> 22</span> </span><span class="COMM">/**
<span class="line"> 23</span>  * Default constructor does nothing (static class).
<span class="line"> 24</span>  * @constructor
<span class="line"> 25</span>  * @class
<span class="line"> 26</span>  * This class provides static methods to perform miscellaneous string-related utility functions.
<span class="line"> 27</span>  *
<span class="line"> 28</span>  * @author Ross Dargahi
<span class="line"> 29</span>  * @author Roland Schemers
<span class="line"> 30</span>  * @author Conrad Damon
<span class="line"> 31</span>  */</span><span class="WHIT">
<span class="line"> 32</span> </span><span class="NAME">AjxStringUtil</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 33</span> 
<span class="line"> 34</span> </span><span class="NAME">AjxStringUtil.TRIM_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/^\s+|\s+$/g</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 35</span> </span><span class="NAME">AjxStringUtil.COMPRESS_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\s+/g</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 36</span> </span><span class="NAME">AjxStringUtil.ELLIPSIS</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34; ... &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 37</span> </span><span class="NAME">AjxStringUtil.LIST_SEP</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;, &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 38</span> 
<span class="line"> 39</span> </span><span class="NAME">AjxStringUtil.CRLF</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\r\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 40</span> </span><span class="NAME">AjxStringUtil.CRLF2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\r\n\r\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 41</span> </span><span class="NAME">AjxStringUtil.CRLF_HTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 42</span> </span><span class="NAME">AjxStringUtil.CRLF2_HTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 43</span> 
<span class="line"> 44</span> </span><span class="COMM">//Regex for image tag having src starting with cid:</span><span class="WHIT">
<span class="line"> 45</span> </span><span class="NAME">AjxStringUtil.IMG_SRC_CID_REGEX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/&lt;img([^&gt;]*)\ssrc=[&#34;&#39;]cid:/gi</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 46</span> 
<span class="line"> 47</span> </span><span class="NAME">AjxStringUtil.makeString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line"> 48</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">val</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 49</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">val</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">val</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 50</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 51</span> 
<span class="line"> 52</span> </span><span class="COMM">/**
<span class="line"> 53</span>  * Capitalizes the specified string by upper-casing the first character
<span class="line"> 54</span>  * and lower-casing the rest of the string.
<span class="line"> 55</span>  *
<span class="line"> 56</span>  * @param {string} str  The string to capitalize.
<span class="line"> 57</span>  */</span><span class="WHIT">
<span class="line"> 58</span> </span><span class="NAME">AjxStringUtil.capitalize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 59</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">str.substr</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 60</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 61</span> 
<span class="line"> 62</span> </span><span class="COMM">/**
<span class="line"> 63</span>  * Capitalizes the specified string by upper-casing the first character.
<span class="line"> 64</span>  * Unlike AjxStringUtil.capitalize - don&#39;t change the rest of the letters.
<span class="line"> 65</span>  *
<span class="line"> 66</span>  * @param {string} str  The string to capitalize.
<span class="line"> 67</span>  */</span><span class="WHIT">
<span class="line"> 68</span> </span><span class="NAME">AjxStringUtil.capitalizeFirstLetter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 69</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">str.substr</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 70</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 71</span> 
<span class="line"> 72</span> 
<span class="line"> 73</span> </span><span class="COMM">/**
<span class="line"> 74</span>  * Capitalizes all the words in the specified string by upper-casing the first
<span class="line"> 75</span>  * character of each word (does not change following characters, so something like MTV stays MTV
<span class="line"> 76</span>  *
<span class="line"> 77</span>  * @param {string} str  The string to capitalize.
<span class="line"> 78</span>  */</span><span class="WHIT">
<span class="line"> 79</span> </span><span class="NAME">AjxStringUtil.capitalizeWords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 80</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxUtil.map</span><span class="PUNC">(</span><span class="NAME">str.split</span><span class="PUNC">(</span><span class="REGX">/\s+/g</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.capitalizeFirstLetter</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34; &#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 81</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 82</span> 
<span class="line"> 83</span> </span><span class="COMM">/**
<span class="line"> 84</span>  * Converts the given text to mixed-case. The input text is one or more words
<span class="line"> 85</span>  * separated by spaces. The output is a single word in mixed (or camel) case.
<span class="line"> 86</span>  * 
<span class="line"> 87</span>  * @param {string}	text		text to convert
<span class="line"> 88</span>  * @param {string|RegEx}	sep		text separator (defaults to any space)
<span class="line"> 89</span>  * @param {boolean}	camel		if &lt;code&gt;true&lt;/code&gt;, first character of result is lower-case
<span class="line"> 90</span>  * @return	{string}	the resulting string
<span class="line"> 91</span>  */</span><span class="WHIT">
<span class="line"> 92</span> </span><span class="NAME">AjxStringUtil.toMixed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line"> 93</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sep</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">camel</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 94</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;string&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 95</span> </span><span class="WHIT">	</span><span class="NAME">sep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sep</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="REGX">/\s+/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 96</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.split</span><span class="PUNC">(</span><span class="NAME">sep</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 97</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 98</span> </span><span class="WHIT">	</span><span class="NAME">newText.push</span><span class="PUNC">(</span><span class="NAME">camel</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 99</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">wds.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">100</span> </span><span class="WHIT">		</span><span class="NAME">newText.push</span><span class="PUNC">(</span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">101</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">102</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">newText.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">103</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">104</span> 
<span class="line">105</span> </span><span class="COMM">/**
<span class="line">106</span>  * Converts the given mixed-case text to a string of one or more words
<span class="line">107</span>  * separated by spaces.
<span class="line">108</span>  *
<span class="line">109</span>  * @param {string} text The mixed-case text.
<span class="line">110</span>  * @param {string} sep  (Optional) The separator between words. Default
<span class="line">111</span>  *                      is a single space.
<span class="line">112</span>  */</span><span class="WHIT">
<span class="line">113</span> </span><span class="NAME">AjxStringUtil.fromMixed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sep</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">114</span> </span><span class="WHIT">    </span><span class="NAME">sep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">&#34;$1&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sep</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;$2&#34;</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">115</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">text.replace</span><span class="PUNC">(</span><span class="REGX">/([a-z])([A-Z]+)/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sep</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">116</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">117</span> 
<span class="line">118</span> </span><span class="COMM">/**
<span class="line">119</span>  * Removes white space from the beginning and end of a string, optionally compressing internal white space. By default, white
<span class="line">120</span>  * space is defined as a sequence of  Unicode whitespace characters (\s in regexes). Optionally, the user can define what
<span class="line">121</span>  * white space is by passing it as an argument.
<span class="line">122</span>  *
<span class="line">123</span>  * &lt;p&gt;TODO: add left/right options&lt;/p&gt;
<span class="line">124</span>  *
<span class="line">125</span>  * @param {string}	str      	the string to trim
<span class="line">126</span>  * @param {boolean}	compress 	whether to compress internal white space to one space
<span class="line">127</span>  * @param {string}	space    	a string that represents a user definition of white space
<span class="line">128</span>  * @return	{string}	a trimmed string
<span class="line">129</span>  */</span><span class="WHIT">
<span class="line">130</span> </span><span class="NAME">AjxStringUtil.trim</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">131</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">compress</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">space</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">132</span> 
<span class="line">133</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">134</span> 
<span class="line">135</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trim_re</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.TRIM_RE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">136</span> 
<span class="line">137</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">compress_re</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.COMPRESS_RE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">138</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">space</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">139</span> </span><span class="WHIT">		</span><span class="NAME">trim_re</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">space</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;+|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">space</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;+$&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;g&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">140</span> </span><span class="WHIT">		</span><span class="NAME">compress_re</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="NAME">space</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;+&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;g&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">141</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">142</span> </span><span class="WHIT">		</span><span class="NAME">space</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">143</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">144</span> </span><span class="WHIT">	</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="NAME">trim_re</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">145</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">compress</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">146</span> </span><span class="WHIT">		</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="NAME">compress_re</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">space</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">147</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">148</span> 
<span class="line">149</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">150</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">151</span> 
<span class="line">152</span> </span><span class="COMM">/**
<span class="line">153</span>  * Returns the string repeated the given number of times.
<span class="line">154</span>  *
<span class="line">155</span>  * @param {string}	str		a string
<span class="line">156</span>  * @param {number}	num		number of times to repeat the string
<span class="line">157</span>  * @return	{string}	the string
<span class="line">158</span>  */</span><span class="WHIT">
<span class="line">159</span> </span><span class="NAME">AjxStringUtil.repeat</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">160</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">num</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">161</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">162</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">num</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">163</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">164</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">165</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">166</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">167</span> 
<span class="line">168</span> </span><span class="COMM">/**
<span class="line">169</span>  * Gets the units from size string.
<span class="line">170</span>  * 
<span class="line">171</span>  * @param	{string}	sizeString	the size string
<span class="line">172</span>  * @return	{string}	the units
<span class="line">173</span>  */</span><span class="WHIT">
<span class="line">174</span> </span><span class="NAME">AjxStringUtil.getUnitsFromSizeString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">175</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">sizeString</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">176</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">units</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;px&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">177</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">sizeString</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;string&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">178</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">digitString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">sizeString</span><span class="PUNC">,</span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">179</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">sizeString.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">digitString.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">180</span> </span><span class="WHIT">			</span><span class="NAME">units</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sizeString.substr</span><span class="PUNC">(</span><span class="NAME">digitString.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">sizeString.length</span><span class="PUNC">-</span><span class="NAME">digitString.length</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">181</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;em&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;ex&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;px&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;in&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;cm&#34;</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;mm&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;pt&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;pc&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">==</span><span class="STRN">&#34;%&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">182</span> </span><span class="WHIT">				</span><span class="NAME">units</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;px&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">183</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">184</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">185</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">186</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">units</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">187</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">188</span> 
<span class="line">189</span> </span><span class="COMM">/**
<span class="line">190</span> * Splits a string, ignoring delimiters that are in quotes or parentheses. Comma
<span class="line">191</span> * is the default split character, but the user can pass in a string of multiple
<span class="line">192</span> * delimiters. It can handle nested parentheses, but not nested quotes.
<span class="line">193</span> *
<span class="line">194</span> * &lt;p&gt;TODO: handle escaped quotes&lt;/p&gt;
<span class="line">195</span> *
<span class="line">196</span> * @param {string} str	the string to split
<span class="line">197</span> * @param {string}	[dels]	an optional string of delimiter characters
<span class="line">198</span> * @return	{array}	an array of strings
<span class="line">199</span> */</span><span class="WHIT">
<span class="line">200</span> </span><span class="NAME">AjxStringUtil.split</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">201</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dels</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">202</span> 
<span class="line">203</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">204</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">205</span> </span><span class="WHIT">	</span><span class="NAME">dels</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dels</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">dels</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;,&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">206</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isDel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Object</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">207</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">dels</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;string&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">208</span> </span><span class="WHIT">		</span><span class="NAME">isDel</span><span class="PUNC">[</span><span class="NAME">dels</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">209</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">210</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">dels.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">211</span> </span><span class="WHIT">			</span><span class="NAME">isDel</span><span class="PUNC">[</span><span class="NAME">dels</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">212</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">213</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">214</span> 
<span class="line">215</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">q</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">216</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">217</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">218</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">chunk</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">219</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">chunks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">220</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">221</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">222</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">c</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">223</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">c</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">224</span> </span><span class="WHIT">			</span><span class="NAME">q</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">q</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">225</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">c</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;(&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">226</span> </span><span class="WHIT">			</span><span class="NAME">p</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">227</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">c</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;)&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">228</span> </span><span class="WHIT">			</span><span class="NAME">p</span><span class="PUNC">--</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">229</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isDel</span><span class="PUNC">[</span><span class="NAME">c</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">230</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">q</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">p</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">231</span> </span><span class="WHIT">				</span><span class="NAME">chunk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.substring</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">232</span> </span><span class="WHIT">				</span><span class="NAME">chunks</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chunk</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">233</span> </span><span class="WHIT">				</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">234</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">235</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">236</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">237</span> </span><span class="WHIT">	</span><span class="NAME">chunk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.substring</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">238</span> </span><span class="WHIT">	</span><span class="NAME">chunks</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chunk</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">239</span> 
<span class="line">240</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">chunks</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">241</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">242</span> 
<span class="line">243</span> </span><span class="NAME">AjxStringUtil.SPACE_WORD_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;\\s*\\S+&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;g&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">244</span> </span><span class="COMM">/**
<span class="line">245</span>  * Splits the line into words, keeping leading whitespace with each word.
<span class="line">246</span>  *
<span class="line">247</span>  * @param {string}	line	the text to split
<span class="line">248</span>  *
<span class="line">249</span>  * @return {array} the array of words
<span class="line">250</span>  */</span><span class="WHIT">
<span class="line">251</span> </span><span class="NAME">AjxStringUtil.splitKeepLeadingWhitespace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">252</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">253</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">words</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">254</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.SPACE_WORD_RE.exec</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">255</span> </span><span class="WHIT">		</span><span class="NAME">words.push</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">256</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">257</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">258</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">259</span> 
<span class="line">260</span> </span><span class="NAME">AjxStringUtil.WRAP_LENGTH</span><span class="WHIT">				</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">80</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">261</span> </span><span class="NAME">AjxStringUtil.HDR_WRAP_LENGTH</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">120</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">262</span> </span><span class="NAME">AjxStringUtil.MAX_HTMLNODE_COUNT</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">250</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">263</span> 
<span class="line">264</span> </span><span class="COMM">// ID for a BLOCKQUOTE to mark it as ours</span><span class="WHIT">
<span class="line">265</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_COLOR</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;#1010FF&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">266</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_STYLE</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;color:#000;font-weight:normal;font-style:normal;text-decoration:none;font-family:Helvetica,Arial,sans-serif;font-size:12pt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">267</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_PREFIX_PRE</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;blockquote style=&#34;border-left:2px solid &#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">268</span> </span><span class="WHIT">									 </span><span class="NAME">AjxStringUtil.HTML_QUOTE_COLOR</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">269</span> </span><span class="WHIT">									 </span><span class="STRN">&#39;;margin-left:5px;padding-left:5px;&#39;</span><span class="PUNC">+</span><span class="WHIT">
<span class="line">270</span> </span><span class="WHIT">									 </span><span class="NAME">AjxStringUtil.HTML_QUOTE_STYLE</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">271</span> </span><span class="WHIT">									 </span><span class="STRN">&#39;&#34;&gt;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">272</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_PREFIX_POST</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;/blockquote&gt;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">273</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_NONPREFIX_PRE</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;div style=&#34;&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">274</span> </span><span class="WHIT">									 </span><span class="NAME">AjxStringUtil.HTML_QUOTE_STYLE</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">275</span> </span><span class="WHIT">									 </span><span class="STRN">&#39;&#34;&gt;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">276</span> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_NONPREFIX_POST</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;/div&gt;&lt;br/&gt;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">277</span> 
<span class="line">278</span> </span><span class="COMM">/**
<span class="line">279</span>  * Wraps text to the given length and optionally quotes it. The level of quoting in the
<span class="line">280</span>  * source text is preserved based on the prefixes. Special lines such as email headers
<span class="line">281</span>  * always start a new line.
<span class="line">282</span>  *
<span class="line">283</span>  * @param {hash}	params	a hash of parameters
<span class="line">284</span>  * @param {string}      text 				the text to be wrapped
<span class="line">285</span>  * @param {number}      len					the desired line length of the wrapped text, defaults to 80
<span class="line">286</span>  * @param {string}      prefix				an optional string to prepend to each line (useful for quoting)
<span class="line">287</span>  * @param {string}      before				text to prepend to final result
<span class="line">288</span>  * @param {string}      after				text to append to final result
<span class="line">289</span>  * @param {boolean}		preserveReturns		if true, don&#39;t combine small lines
<span class="line">290</span>  * @param {boolean}		isHeaders			if true, we are wrapping a block of email headers
<span class="line">291</span>  * @param {boolean}		isFlowed			format text for display as flowed (RFC 3676)
<span class="line">292</span>  * @param {boolean}		htmlMode			if true, surround the content with the before and after
<span class="line">293</span>  *
<span class="line">294</span>  * @return	{string}	the wrapped/quoted text
<span class="line">295</span>  */</span><span class="WHIT">
<span class="line">296</span> </span><span class="NAME">AjxStringUtil.wordWrap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">297</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">params</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">298</span> 
<span class="line">299</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">params</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">params.text</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">300</span> 
<span class="line">301</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">302</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">before</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.before</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">303</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">after</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.after</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">304</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isFlowed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.isFlowed</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">305</span> 
<span class="line">306</span> </span><span class="WHIT">	</span><span class="COMM">// For HTML, just surround the content with the before and after, which is</span><span class="WHIT">
<span class="line">307</span> </span><span class="WHIT">	</span><span class="COMM">// typically a block-level element that puts a border on the left</span><span class="WHIT">
<span class="line">308</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">params.htmlMode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">309</span> </span><span class="WHIT">		</span><span class="NAME">before</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.before</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">params.prefix</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_PREFIX_PRE</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_NONPREFIX_PRE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">310</span> </span><span class="WHIT">		</span><span class="NAME">after</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.after</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">params.prefix</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_PREFIX_POST</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HTML_QUOTE_NONPREFIX_POST</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">311</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">before</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">after</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">312</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">313</span> 
<span class="line">314</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">max</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.len</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">params.isHeaders</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HDR_WRAP_LENGTH</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.WRAP_LENGTH</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">315</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.prefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">316</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">317</span> 
<span class="line">318</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.split</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.SPLIT_RE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">319</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">words</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">320</span> 
<span class="line">321</span> </span><span class="WHIT">	</span><span class="COMM">// Divides lines into words. Each word is part of a hash that also has</span><span class="WHIT">
<span class="line">322</span> </span><span class="WHIT">	</span><span class="COMM">// the word&#39;s prefix, whether it&#39;s a paragraph break, and whether it</span><span class="WHIT">
<span class="line">323</span> </span><span class="WHIT">	</span><span class="COMM">// needs to be preserved at the start or end of a line.</span><span class="WHIT">
<span class="line">324</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">llen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">llen</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">l</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">325</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">l</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">326</span> </span><span class="WHIT">		</span><span class="COMM">// get this line&#39;s prefix</span><span class="WHIT">
<span class="line">327</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">line.match</span><span class="PUNC">(</span><span class="REGX">/^([\s&gt;\|]+)/</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">328</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">329</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">prefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">330</span> </span><span class="WHIT">			</span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">line.substr</span><span class="PUNC">(</span><span class="NAME">prefix.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">331</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">332</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">333</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.splitKeepLeadingWhitespace</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">334</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">335</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mustStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.MSG_SEP_RE.test</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.COLON_RE.test</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">336</span> </span><span class="WHIT">								</span><span class="NAME">AjxStringUtil.HDR_RE.test</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">params.isHeaders</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.SIG_RE.test</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">337</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mustEnd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.preserveReturns</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">338</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isFlowed</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">339</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">line.match</span><span class="PUNC">(</span><span class="REGX">/( +)$/</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">340</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">m</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">341</span> </span><span class="WHIT">						</span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NAME">wds.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="COMM">// preserve trailing space at end of line</span><span class="WHIT">
<span class="line">342</span> </span><span class="WHIT">						</span><span class="NAME">mustEnd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">343</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">344</span> </span><span class="WHIT">					</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">345</span> </span><span class="WHIT">						</span><span class="NAME">mustEnd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">346</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">347</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">348</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">wlen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">wds.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">wlen</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">w</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">349</span> </span><span class="WHIT">					</span><span class="NAME">words.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">350</span> </span><span class="WHIT">						</span><span class="NAME">w</span><span class="PUNC">:</span><span class="WHIT">			</span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NAME">w</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">351</span> </span><span class="WHIT">						</span><span class="NAME">prefix</span><span class="PUNC">:</span><span class="WHIT">		</span><span class="NAME">prefix</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">352</span> </span><span class="WHIT">						</span><span class="NAME">mustStart</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="PUNC">(</span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">mustStart</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">353</span> </span><span class="WHIT">						</span><span class="NAME">mustEnd</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="PUNC">(</span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">wlen</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">mustEnd</span><span class="WHIT">
<span class="line">354</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">355</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">356</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">357</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">358</span> </span><span class="WHIT">			</span><span class="COMM">// paragraph marker</span><span class="WHIT">
<span class="line">359</span> </span><span class="WHIT">			</span><span class="NAME">words.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">360</span> </span><span class="WHIT">				</span><span class="NAME">para</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">361</span> </span><span class="WHIT">				</span><span class="NAME">prefix</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">prefix</span><span class="WHIT">
<span class="line">362</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">363</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">364</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">365</span> 
<span class="line">366</span> </span><span class="WHIT">	</span><span class="COMM">// Take the array of words and put them back together. We break for a new line</span><span class="WHIT">
<span class="line">367</span> </span><span class="WHIT">	</span><span class="COMM">// when we hit the max line length, change prefixes, or hit a word that must start a new line.</span><span class="WHIT">
<span class="line">368</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">curLen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">369</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">words.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">370</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">word</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">371</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">word.w</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">prefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">word.prefix</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">372</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">373</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">curPrefix.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">374</span> </span><span class="WHIT">		</span><span class="NAME">pl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">375</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">376</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">word.para</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">377</span> </span><span class="WHIT">			</span><span class="COMM">// paragraph break - output what we have, then add a blank line</span><span class="WHIT">
<span class="line">378</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">wds.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">379</span> </span><span class="WHIT">				</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">wds.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/^ +/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">380</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">381</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">words.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">382</span> </span><span class="WHIT">				</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">prefix</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">383</span> </span><span class="WHIT">				</span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">384</span> </span><span class="WHIT">				</span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">385</span> </span><span class="WHIT">				</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">386</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">387</span> </span><span class="WHIT">			</span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">388</span> </span><span class="WHIT">			</span><span class="NAME">curLen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">389</span> </span><span class="WHIT">			</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">390</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">pl</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">curLen</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">w.length</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">max</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">prefix</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">word.mustStart</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">391</span> </span><span class="WHIT">			</span><span class="COMM">// still room left on the current line, add the word</span><span class="WHIT">
<span class="line">392</span> </span><span class="WHIT">			</span><span class="NAME">wds.push</span><span class="PUNC">(</span><span class="NAME">w</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">393</span> </span><span class="WHIT">			</span><span class="NAME">curLen</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">w.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">394</span> </span><span class="WHIT">			</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">prefix</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">395</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">word.mustEnd</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">396</span> </span><span class="WHIT">				</span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">mustStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">397</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">398</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">399</span> </span><span class="WHIT">			</span><span class="COMM">// no more room - output what we have and start a new line</span><span class="WHIT">
<span class="line">400</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">wds.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">401</span> </span><span class="WHIT">				</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">wds.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/^ +/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">402</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">403</span> </span><span class="WHIT">			</span><span class="NAME">wds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">w</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">404</span> </span><span class="WHIT">			</span><span class="NAME">curLen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">w.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">405</span> </span><span class="WHIT">			</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">prefix</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">406</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">word.mustEnd</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">407</span> </span><span class="WHIT">				</span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">mustStart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">408</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">409</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">410</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">411</span> 
<span class="line">412</span> </span><span class="WHIT">	</span><span class="COMM">// handle last line</span><span class="WHIT">
<span class="line">413</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">wds.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">414</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wds</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">prefix</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">prefixChar</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">415</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">addPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">416</span> </span><span class="WHIT">		</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newPrefix</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">wds.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/^ /</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">417</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">418</span> 
<span class="line">419</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">before</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">after</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">420</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">421</span> 
<span class="line">422</span> </span><span class="COMM">/**
<span class="line">423</span>  * Quotes text with the given quote character. For HTML, surrounds the text with the
<span class="line">424</span>  * given strings. Does no wrapping.
<span class="line">425</span>  *
<span class="line">426</span>  * @param {hash}	params	a hash of parameters
<span class="line">427</span>  * @param {string}      params.text 				the text to be wrapped
<span class="line">428</span>  * @param {string}      [params.pre]				prefix for quoting
<span class="line">429</span>  * @param {string}      [params.before]				text to prepend to final result
<span class="line">430</span>  * @param {string}      [params.after]				text to append to final result
<span class="line">431</span>  *
<span class="line">432</span>  * @return	{string}	the quoted text
<span class="line">433</span>  */</span><span class="WHIT">
<span class="line">434</span> </span><span class="NAME">AjxStringUtil.quoteText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">435</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">params</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">436</span> 
<span class="line">437</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">params</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">params.text</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">438</span> 
<span class="line">439</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">440</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">before</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.before</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">after</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.after</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">441</span> 
<span class="line">442</span> </span><span class="WHIT">	</span><span class="COMM">// For HTML, just surround the content with the before and after, which is</span><span class="WHIT">
<span class="line">443</span> </span><span class="WHIT">	</span><span class="COMM">// typically a block-level element that puts a border on the left</span><span class="WHIT">
<span class="line">444</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">params.htmlMode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">params.pre</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">445</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">before</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">after</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">446</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">447</span> 
<span class="line">448</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.len</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NUMB">80</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">449</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pre</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">params.pre</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">450</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">451</span> 
<span class="line">452</span> </span><span class="WHIT">	</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">453</span> </span><span class="WHIT">	</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.replace</span><span class="PUNC">(</span><span class="REGX">/\n\r/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">454</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.split</span><span class="PUNC">(</span><span class="NAME">eol</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">455</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">456</span> 
<span class="line">457</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">llen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">llen</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">l</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">458</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">l</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">459</span> </span><span class="WHIT">		</span><span class="NAME">result.push</span><span class="PUNC">(</span><span class="NAME">pre</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">eol</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">460</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">461</span> 
<span class="line">462</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">before</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">result.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">after</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">463</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">464</span> 
<span class="line">465</span> </span><span class="NAME">AjxStringUtil.SHIFT_CHAR</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NUMB">48</span><span class="PUNC">:</span><span class="STRN">&#39;)&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">49</span><span class="PUNC">:</span><span class="STRN">&#39;!&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">50</span><span class="PUNC">:</span><span class="STRN">&#39;@&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">51</span><span class="PUNC">:</span><span class="STRN">&#39;#&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">52</span><span class="PUNC">:</span><span class="STRN">&#39;$&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">53</span><span class="PUNC">:</span><span class="STRN">&#39;%&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">54</span><span class="PUNC">:</span><span class="STRN">&#39;^&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">55</span><span class="PUNC">:</span><span class="STRN">&#39;&amp;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">56</span><span class="PUNC">:</span><span class="STRN">&#39;*&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">57</span><span class="PUNC">:</span><span class="STRN">&#39;(&#39;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">466</span> </span><span class="WHIT">							</span><span class="NUMB">59</span><span class="PUNC">:</span><span class="STRN">&#39;:&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">186</span><span class="PUNC">:</span><span class="STRN">&#39;:&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">187</span><span class="PUNC">:</span><span class="STRN">&#39;+&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">188</span><span class="PUNC">:</span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">189</span><span class="PUNC">:</span><span class="STRN">&#39;_&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">190</span><span class="PUNC">:</span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">191</span><span class="PUNC">:</span><span class="STRN">&#39;?&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">192</span><span class="PUNC">:</span><span class="STRN">&#39;~&#39;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">467</span> </span><span class="WHIT">							</span><span class="NUMB">219</span><span class="PUNC">:</span><span class="STRN">&#39;{&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">220</span><span class="PUNC">:</span><span class="STRN">&#39;|&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">221</span><span class="PUNC">:</span><span class="STRN">&#39;}&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">222</span><span class="PUNC">:</span><span class="STRN">&#39;&#34;&#39;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">468</span> 
<span class="line">469</span> </span><span class="COMM">/**
<span class="line">470</span> * Returns the character for the given key, taking the shift key into consideration.
<span class="line">471</span> *
<span class="line">472</span> * @param {number}	keycode	a numeric keycode (not a character code)
<span class="line">473</span> * @param {boolean}	shifted		whether the shift key is down
<span class="line">474</span> * @return	{char}	a character
<span class="line">475</span> */</span><span class="WHIT">
<span class="line">476</span> </span><span class="NAME">AjxStringUtil.shiftChar</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">477</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">keycode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">shifted</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">478</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">shifted</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.SHIFT_CHAR</span><span class="PUNC">[</span><span class="NAME">keycode</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">keycode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">keycode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">479</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">480</span> 
<span class="line">481</span> </span><span class="COMM">/**
<span class="line">482</span>  * Does a diff between two strings, returning the index of the first differing character.
<span class="line">483</span>  *
<span class="line">484</span>  * @param {string}	str1	a string
<span class="line">485</span>  * @param {string}	str2	another string
<span class="line">486</span>  * @return	{number}	the index at which they first differ
<span class="line">487</span>  */</span><span class="WHIT">
<span class="line">488</span> </span><span class="NAME">AjxStringUtil.diffPoint</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">489</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">str2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">490</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">str1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">str2</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">491</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">492</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">493</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.min</span><span class="PUNC">(</span><span class="NAME">str1.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">str2.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">494</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">495</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">str1.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">str2.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">496</span> </span><span class="WHIT">		</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">497</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">498</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">499</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">500</span> 
<span class="line">501</span> </span><span class="COMM">/*
<span class="line">502</span> * DEPRECATED
<span class="line">503</span> *
<span class="line">504</span> * Replaces variables in a string with values from a list. The variables are
<span class="line">505</span> * denoted by a &#39;$&#39; followed by a number, starting from 0. For example, a string
<span class="line">506</span> * of &#34;Hello $0, meet $1&#34; with a list of [&#34;Harry&#34;, &#34;Sally&#34;] would result in the
<span class="line">507</span> * string &#34;Hello Harry, meet Sally&#34;.
<span class="line">508</span> *
<span class="line">509</span> * @param str		the string to resolve
<span class="line">510</span> * @param values	 	an array of values to interpolate
<span class="line">511</span> * @returns			a string with the variables replaced
<span class="line">512</span> * 
<span class="line">513</span> * @deprecated
<span class="line">514</span> */</span><span class="WHIT">
<span class="line">515</span> </span><span class="NAME">AjxStringUtil.resolve</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">516</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">values</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">517</span> </span><span class="WHIT">	</span><span class="NAME">DBG.println</span><span class="PUNC">(</span><span class="NAME">AjxDebug.DBG1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;Call to deprecated function AjxStringUtil.resolve&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">518</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxMessageFormat.format</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">values</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">519</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">520</span> 
<span class="line">521</span> </span><span class="COMM">/**
<span class="line">522</span>  * Encodes a complete URL. Leaves delimiters alone.
<span class="line">523</span>  *
<span class="line">524</span>  * @param {string}	str	the string to encode
<span class="line">525</span>  * @return	{string}	the encoded string
<span class="line">526</span>  */</span><span class="WHIT">
<span class="line">527</span> </span><span class="NAME">AjxStringUtil.urlEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">528</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">529</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">530</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.encodeURL</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">window.encodeURI</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">531</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">532</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">533</span> 
<span class="line">534</span> </span><span class="COMM">/**
<span class="line">535</span>  * Encodes a string as if it were a &lt;em&gt;part&lt;/em&gt; of a URL. The
<span class="line">536</span>  * difference between this function and {@link AjxStringUtil.urlEncode}
<span class="line">537</span>  * is that this will also encode the following delimiters:
<span class="line">538</span>  *
<span class="line">539</span>  * &lt;pre&gt;
<span class="line">540</span>  *  			: / ? &amp; =
<span class="line">541</span>  * &lt;/pre&gt;
<span class="line">542</span>  * 
<span class="line">543</span>  * @param	{string}	str		the string to encode
<span class="line">544</span>  * @return	{string}	the resulting string
<span class="line">545</span>  */</span><span class="WHIT">
<span class="line">546</span> </span><span class="NAME">AjxStringUtil.urlComponentEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">547</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">548</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">549</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.encodeURLComponent</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">window.encodeURIComponent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">550</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">551</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">552</span> 
<span class="line">553</span> </span><span class="COMM">/**
<span class="line">554</span>  * Decodes a complete URL.
<span class="line">555</span>  *
<span class="line">556</span>  * @param {string}	str	the string to decode
<span class="line">557</span>  * @return	{string}	the decoded string
<span class="line">558</span>  */</span><span class="WHIT">
<span class="line">559</span> </span><span class="NAME">AjxStringUtil.urlDecode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">560</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">561</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">562</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.decodeURL</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">window.decodeURI</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">563</span> </span><span class="WHIT">	</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">564</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">565</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">566</span> </span><span class="WHIT">	</span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">567</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">568</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">569</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">570</span> 
<span class="line">571</span> </span><span class="COMM">/**
<span class="line">572</span>  * Decodes a string as if it were a &lt;em&gt;part&lt;/em&gt; of a URL. Falls back
<span class="line">573</span>  * to unescape() if necessary.
<span class="line">574</span>  * 
<span class="line">575</span>  * @param	{string}	str		the string to decode
<span class="line">576</span>  * @return	{string}	the decoded string
<span class="line">577</span>  */</span><span class="WHIT">
<span class="line">578</span> </span><span class="NAME">AjxStringUtil.urlComponentDecode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">579</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">580</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">581</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.decodeURLComponent</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">window.decodeURIComponent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">582</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">583</span> </span><span class="WHIT">	</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">584</span> </span><span class="WHIT">		</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">585</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">586</span> </span><span class="WHIT">		</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">unescape</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">587</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">588</span> 
<span class="line">589</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">590</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">591</span> 
<span class="line">592</span> </span><span class="NAME">AjxStringUtil.ENCODE_MAP</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">593</span> 
<span class="line">594</span> </span><span class="COMM">/**
<span class="line">595</span>  * HTML-encodes a string.
<span class="line">596</span>  *
<span class="line">597</span>  * @param {string}	str	the string to encode
<span class="line">598</span>  * @param	{boolean}	includeSpaces		if &lt;code&gt;true&lt;/code&gt;, to include encoding spaces
<span class="line">599</span>  * @return	{string}	the encoded string
<span class="line">600</span>  */</span><span class="WHIT">
<span class="line">601</span> </span><span class="NAME">AjxStringUtil.htmlEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">602</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">includeSpaces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">603</span> 
<span class="line">604</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">605</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;string&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">606</span> </span><span class="WHIT">		</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.toString</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">607</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">608</span> 
<span class="line">609</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxEnv.isSafari</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxEnv.isSafariNightly</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">610</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">includeSpaces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">611</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[&lt;&gt;&amp;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">htmlChar</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ENCODE_MAP</span><span class="PUNC">[</span><span class="NAME">htmlChar</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/  /g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39; &nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">612</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">613</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[&lt;&gt;&amp;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">htmlChar</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ENCODE_MAP</span><span class="PUNC">[</span><span class="NAME">htmlChar</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">614</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">615</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">616</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">includeSpaces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">617</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[&amp;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/  /g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39; &nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&lt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&gt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">618</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">619</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[&amp;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&lt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&gt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">620</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">621</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">622</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">623</span> 
<span class="line">624</span> </span><span class="COMM">/**
<span class="line">625</span>  * encode quotes for using in inline JS code, so the text does not end a quoted param prematurely.
<span class="line">626</span>  * @param str
<span class="line">627</span>  */</span><span class="WHIT">
<span class="line">628</span> </span><span class="NAME">AjxStringUtil.encodeQuotes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">629</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">630</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&#34;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&#39;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#39;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">631</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">632</span> 
<span class="line">633</span> 
<span class="line">634</span> </span><span class="COMM">/**
<span class="line">635</span>  * Decodes the string.
<span class="line">636</span>  * 
<span class="line">637</span>  * @param	{string}	str		the string to decode
<span class="line">638</span>  * @param	{boolean}	decodeSpaces	if &lt;code&gt;true&lt;/code&gt;, decode spaces
<span class="line">639</span>  * @return	{string}	the string
<span class="line">640</span>  */</span><span class="WHIT">
<span class="line">641</span> </span><span class="NAME">AjxStringUtil.htmlDecode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">642</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">decodeSpaces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">643</span> </span><span class="WHIT">	 
<span class="line">644</span> 	 </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">decodeSpaces</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">645</span> </span><span class="WHIT">	 	</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&nbsp;/g</span><span class="PUNC">,</span><span class="STRN">&#34; &#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">646</span> </span><span class="WHIT">	 	
<span class="line">647</span>      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&amp;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&gt;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&gt;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">648</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">649</span> 
<span class="line">650</span> </span><span class="NAME">AjxStringUtil.__jsEscapeChar</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">c</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">651</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">codestr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c.charCodeAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="NUMB">16</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">652</span> 
<span class="line">653</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">codestr.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">654</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#39;\\u000&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">codestr</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">655</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">codestr.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">656</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#39;\\u00&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">codestr</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">657</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">codestr.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">658</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#39;\\u0&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">codestr</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">659</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">codestr.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">660</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#39;\\u&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">codestr</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">661</span> 
<span class="line">662</span> </span><span class="WHIT">	</span><span class="COMM">// shouldn&#39;t happen -- ECMAscript proscribes that strings are</span><span class="WHIT">
<span class="line">663</span> </span><span class="WHIT">	</span><span class="COMM">// UTF-16 internally</span><span class="WHIT">
<span class="line">664</span> </span><span class="WHIT">	</span><span class="NAME">DBG.println</span><span class="PUNC">(</span><span class="NAME">AjxDebug.NONE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;unexpected condition in &#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">665</span> </span><span class="WHIT">	            </span><span class="STRN">&#34;AjxStringUtil.__jsEscapeChar -- code point 0x&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">666</span> </span><span class="WHIT">	            </span><span class="NAME">codestr</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; doesn&#39;t fit in 16 bits&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">667</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">668</span> 
<span class="line">669</span> </span><span class="COMM">/**
<span class="line">670</span>  * Encodes non-ASCII and non-printable characters as \uXXXX, suitable
<span class="line">671</span>  * for JSON.
<span class="line">672</span>  *
<span class="line">673</span>  * @param	{string}	str		the string
<span class="line">674</span>  * @return	{string}	the encoded string
<span class="line">675</span>  */</span><span class="WHIT">
<span class="line">676</span> </span><span class="NAME">AjxStringUtil.jsEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">677</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">678</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[^\u0020-\u007e]/g</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">679</span> </span><span class="WHIT">	                   </span><span class="NAME">AjxStringUtil.__jsEscapeChar</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">680</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">681</span> 
<span class="line">682</span> </span><span class="COMM">/**
<span class="line">683</span>  * Removes HTML tags from the given string.
<span class="line">684</span>  * 
<span class="line">685</span>  * @param {string}	str			text from which to strip tags
<span class="line">686</span>  * @param {boolean}	removeContent	if &lt;code&gt;true&lt;/code&gt;, also remove content within tags
<span class="line">687</span>  * @return	{string}	the resulting HTML string
<span class="line">688</span>  */</span><span class="WHIT">
<span class="line">689</span> </span><span class="NAME">AjxStringUtil.stripTags</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">690</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">removeContent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">691</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#39;string&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">692</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">693</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">694</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">removeContent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">695</span> </span><span class="WHIT">		</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/(&lt;(\w+)[^&gt;]*&gt;).*(&lt;\/\2[^&gt;]*&gt;)/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;$1$3&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">696</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">697</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&lt;\/?[^&gt;]+&gt;/gi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">698</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">699</span> 
<span class="line">700</span> </span><span class="COMM">/**
<span class="line">701</span>  * Converts the string to HTML.
<span class="line">702</span>  * 
<span class="line">703</span>  * @param	{string}	str		the string
<span class="line">704</span>  * @return	{string}	the resulting string
<span class="line">705</span>  */</span><span class="WHIT">
<span class="line">706</span> </span><span class="NAME">AjxStringUtil.convertToHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">707</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">quotePrefix</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">openTag</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">closeTag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">708</span> 
<span class="line">709</span> </span><span class="WHIT">	</span><span class="NAME">openTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">openTag</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;blockquote&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">710</span> </span><span class="WHIT">	</span><span class="NAME">closeTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">closeTag</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;/blockquote&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">711</span> </span><span class="WHIT">	
<span class="line">712</span> 	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">713</span> 
<span class="line">714</span> </span><span class="WHIT">	</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.htmlEncode</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">715</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">quotePrefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">716</span> </span><span class="WHIT">		</span><span class="COMM">// Convert a section of lines prefixed with &gt; or |</span><span class="WHIT">
<span class="line">717</span> </span><span class="WHIT">		</span><span class="COMM">// to a section encapsuled in &lt;blockquote&gt; tags</span><span class="WHIT">
<span class="line">718</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prefix_re</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/^(&gt;|&gt;|\|\s+)/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">719</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.split</span><span class="PUNC">(</span><span class="REGX">/\r?\n/</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">720</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">level</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">721</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">lines.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">722</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">723</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">line.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">724</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lineLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">725</span> </span><span class="WHIT">				</span><span class="COMM">// Remove prefixes while counting how many there are on the line</span><span class="WHIT">
<span class="line">726</span> </span><span class="WHIT">				</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">line.match</span><span class="PUNC">(</span><span class="NAME">prefix_re</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">727</span> </span><span class="WHIT">					</span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">line.replace</span><span class="PUNC">(</span><span class="NAME">prefix_re</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">728</span> </span><span class="WHIT">					</span><span class="NAME">lineLevel</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">729</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">730</span> </span><span class="WHIT">				</span><span class="COMM">// If the lineLevel has changed since the last line, add blockquote start or end tags, and adjust level accordingly</span><span class="WHIT">
<span class="line">731</span> </span><span class="WHIT">				</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">lineLevel</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">level</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">732</span> </span><span class="WHIT">					</span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">openTag</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">line</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">733</span> </span><span class="WHIT">					</span><span class="NAME">level</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">734</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">735</span> </span><span class="WHIT">				</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">lineLevel</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">level</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">736</span> </span><span class="WHIT">					</span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">closeTag</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">737</span> </span><span class="WHIT">					</span><span class="NAME">level</span><span class="PUNC">--</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">738</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">739</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">740</span> </span><span class="WHIT">			</span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">line</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">741</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">742</span> </span><span class="WHIT">		</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">level</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">743</span> </span><span class="WHIT">			</span><span class="NAME">lines.push</span><span class="PUNC">(</span><span class="NAME">closeTag</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">744</span> </span><span class="WHIT">			</span><span class="NAME">level</span><span class="PUNC">--</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">745</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">746</span> 
<span class="line">747</span> </span><span class="WHIT">		</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines.join</span><span class="PUNC">(</span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">748</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">749</span> 
<span class="line">750</span> </span><span class="WHIT">	</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT">
<span class="line">751</span> </span><span class="WHIT">		</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/  /mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39; &nbsp;&#39;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">752</span> </span><span class="WHIT">		</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/^ /mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">753</span> </span><span class="WHIT">		</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\t/mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">754</span> </span><span class="WHIT">		</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\r?\n/mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">755</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">756</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">757</span> 
<span class="line">758</span> </span><span class="NAME">AjxStringUtil.SPACE_ENCODE_MAP</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="STRN">&#39; &#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="WHIT"> </span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;\n&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;br&gt;&#39;</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">759</span> 
<span class="line">760</span> </span><span class="COMM">/**
<span class="line">761</span>  * HTML-encodes a string.
<span class="line">762</span>  *
<span class="line">763</span>  * @param {string}	str	the string to encode
<span class="line">764</span>  * 
<span class="line">765</span>  * @private
<span class="line">766</span>  */</span><span class="WHIT">
<span class="line">767</span> </span><span class="NAME">AjxStringUtil.htmlEncodeSpace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">768</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">769</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">770</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/[&amp;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/ /g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&lt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[&gt;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">771</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">772</span> 
<span class="line">773</span> </span><span class="COMM">/**
<span class="line">774</span>  * Encode
<span class="line">775</span>  * @param base {string} Ruby base.
<span class="line">776</span>  * @param text {string} Ruby text (aka furigana).
<span class="line">777</span>  */</span><span class="WHIT">
<span class="line">778</span> </span><span class="NAME">AjxStringUtil.htmlRubyEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">base</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">779</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">base</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">780</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class="line">781</span> </span><span class="WHIT">            </span><span class="STRN">&#34;&lt;ruby&gt;&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">782</span> </span><span class="WHIT">                </span><span class="STRN">&#34;&lt;rb&gt;&#34;</span><span class="PUNC">,</span><span class="NAME">AjxStringUtil.htmlEncode</span><span class="PUNC">(</span><span class="NAME">base</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;/rb&gt; &#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">783</span> </span><span class="WHIT">                </span><span class="STRN">&#34;&lt;rp&gt;(&lt;/rp&gt;&lt;rt&gt;&#34;</span><span class="PUNC">,</span><span class="NAME">AjxStringUtil.htmlEncode</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;/rt&gt;&lt;rp&gt;)&lt;/rp&gt;&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">784</span> </span><span class="WHIT">            </span><span class="STRN">&#34;&lt;/ruby&gt;&#34;</span><span class="WHIT">
<span class="line">785</span> </span><span class="WHIT">        </span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">786</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">787</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.htmlEncode</span><span class="PUNC">(</span><span class="NAME">base</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">788</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">789</span> 
<span class="line">790</span> </span><span class="COMM">// this function makes sure a leading space is preservered, takes care of tabs,</span><span class="WHIT">
<span class="line">791</span> </span><span class="COMM">// then finally takes replaces newlines with &lt;br&gt;&#39;s</span><span class="WHIT">
<span class="line">792</span> </span><span class="NAME">AjxStringUtil.nl2br</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">793</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">794</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">795</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/^ /mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&nbsp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="WHIT">
<span class="line">796</span> </span><span class="WHIT">		</span><span class="COMM">// replace(/\t/g, &#34;&lt;pre style=&#39;display:inline;&#39;&gt;\t&lt;/pre&gt;&#34;).</span><span class="WHIT">
<span class="line">797</span> </span><span class="WHIT">		</span><span class="COMM">// replace(/\t/mg, &#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;).</span><span class="WHIT">
<span class="line">798</span> </span><span class="WHIT">		</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\t/mg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;span style=&#39;white-space:pre&#39;&gt;\t&lt;/span&gt;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="WHIT">
<span class="line">799</span> </span><span class="WHIT">		</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\n/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">800</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">801</span> 
<span class="line">802</span> </span><span class="NAME">AjxStringUtil.xmlEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">803</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">804</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">805</span> </span><span class="WHIT">		</span><span class="COMM">// bug fix #8779 - safari barfs if &#34;str&#34; is not a String type</span><span class="WHIT">
<span class="line">806</span> </span><span class="WHIT">		</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">807</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&amp;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">808</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">809</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">810</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">811</span> 
<span class="line">812</span> </span><span class="NAME">AjxStringUtil.xmlDecode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">813</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">814</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&amp;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">815</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">816</span> 
<span class="line">817</span> </span><span class="NAME">AjxStringUtil.xmlAttrEncode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">818</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">819</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&amp;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\x22/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\x27/g</span><span class="PUNC">,</span><span class="STRN">&#34;&#39;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">820</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">821</span> 
<span class="line">822</span> </span><span class="NAME">AjxStringUtil.xmlAttrDecode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">823</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">824</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/&amp;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&lt;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&#34;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&#39;/g</span><span class="PUNC">,</span><span class="STRN">&#34;&#39;&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">825</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">826</span> 
<span class="line">827</span> </span><span class="NAME">AjxStringUtil.__RE_META</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">:</span><span class="STRN">&#34; &#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">:</span><span class="STRN">&#34;\\n&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;\r&#34;</span><span class="PUNC">:</span><span class="STRN">&#34;\\r&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;\t&#34;</span><span class="PUNC">:</span><span class="STRN">&#34;\\t&#34;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">828</span> </span><span class="NAME">AjxStringUtil.__reMetaEscape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">$0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">$1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">829</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.__RE_META</span><span class="PUNC">[</span><span class="NAME">$1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#34;\\&#34;</span><span class="PUNC">+</span><span class="NAME">$1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">830</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">831</span> </span><span class="NAME">AjxStringUtil.regExEscape</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">832</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">833</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str.replace</span><span class="PUNC">(</span><span class="REGX">/(\W)/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.__reMetaEscape</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">834</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">835</span> 
<span class="line">836</span> </span><span class="NAME">AjxStringUtil._calcDIV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// used by &#39;clip()&#39; and &#39;wrap()&#39; functions</span><span class="WHIT">
<span class="line">837</span> 
<span class="line">838</span> </span><span class="NAME">AjxStringUtil.calcDIV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">839</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">840</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._calcDIV</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">841</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._calcDIV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;div&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">842</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._calcDIV.style.zIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">843</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._calcDIV.style.position</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">DwtControl.ABSOLUTE_STYLE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">844</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._calcDIV.style.visibility</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;hidden&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">845</span> </span><span class="WHIT">		</span><span class="NAME">document.body.appendChild</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._calcDIV</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">846</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">847</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._calcDIV</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">848</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">849</span> 
<span class="line">850</span> </span><span class="COMM">/**
<span class="line">851</span>  * Clips a string at &#34;pixelWidth&#34; using using &#34;className&#34; on hidden &#39;AjxStringUtil._calcDIV&#39;.
<span class="line">852</span>  * Returns &#34;origString&#34; with &#34;...&#34; appended if clipped.
<span class="line">853</span>  *
<span class="line">854</span>  * NOTE: The same CSS style (&#34;className&#34;) must be assigned to both the intended
<span class="line">855</span>  * display area and the hidden &#39;AjxStringUtil._calcDIV&#39;.  &#34;className&#34; is
<span class="line">856</span>  * optional; if supplied, it will be assigned to &#39;AjxStringUtil._calcDIV&#39; to
<span class="line">857</span>  * handle different CSS styles (&#34;className&#34;s) on same page.
<span class="line">858</span>  *
<span class="line">859</span>  * NOTE2: MSIE Benchmark - clipping an average of 17 characters each over 190
<span class="line">860</span>  * iterations averaged 27ms each (5.1 seconds total for 190)
<span class="line">861</span>  * 
<span class="line">862</span>  * @private
<span class="line">863</span>  */</span><span class="WHIT">
<span class="line">864</span> </span><span class="NAME">AjxStringUtil.clip</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">865</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">origString</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">className</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">866</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">calcDIV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.calcDIV</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">867</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">calcDIV.className</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">className</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">868</span> </span><span class="WHIT">	</span><span class="COMM">//calcDIV.innerHTML = &#34;&lt;div&gt;&#34; + origString + &#34;&lt;/div&gt;&#34;; // prevents screen flash in IE?</span><span class="WHIT">
<span class="line">869</span> </span><span class="WHIT">	</span><span class="NAME">calcDIV.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">origString</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">870</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">calcDIV.offsetWidth</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">origString</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">871</span> 
<span class="line">872</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NAME">origString.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&gt;</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">--</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">873</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">origString.substr</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">874</span> </span><span class="WHIT">		</span><span class="NAME">calcDIV.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ELLIPSIS</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">875</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">calcDIV.offsetWidth</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ELLIPSIS</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">876</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">877</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">origString</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">878</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">879</span> 
<span class="line">880</span> </span><span class="NAME">AjxStringUtil.clipByLength</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">881</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="NAME">clipLen</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">882</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">883</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">clipLen</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">884</span> </span><span class="WHIT">		</span><span class="PUNC">?</span><span class="WHIT">  </span><span class="NAME">str</span><span class="WHIT">
<span class="line">885</span> </span><span class="WHIT">		</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">str.substr</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">clipLen</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;...&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">str.substring</span><span class="PUNC">(</span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">clipLen</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">len</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">886</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">887</span> 
<span class="line">888</span> </span><span class="COMM">/**
<span class="line">889</span>  * Forces a string to wrap at &#34;pixelWidth&#34; using &#34;className&#34; on hidden &#39;AjxStringUtil._calcDIV&#39;.
<span class="line">890</span>  * Returns &#34;origString&#34; with &#34;&lt;br&gt;&#34; tags inserted to force wrapping.
<span class="line">891</span>  * Breaks string on embedded space characters, EOL (&#34;/n&#34;) and &#34;&lt;br&gt;&#34; tags when possible.
<span class="line">892</span>  *
<span class="line">893</span>  * @returns		&#34;origString&#34; with &#34;&lt;br&gt;&#34; tags inserted to force wrapping.
<span class="line">894</span>  * 
<span class="line">895</span>  * @private
<span class="line">896</span>  */</span><span class="WHIT">
<span class="line">897</span> </span><span class="NAME">AjxStringUtil.wrap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">898</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">origString</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">className</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">899</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">calcDIV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.calcDIV</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">900</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">calcDIV.className</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">className</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">901</span> 
<span class="line">902</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">903</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">904</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">textRows</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">origString.split</span><span class="PUNC">(</span><span class="STRN">&#34;/n&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">905</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">trCount</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">textRows.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">trCount</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">906</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">trCount</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">907</span> </span><span class="WHIT">			</span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">908</span> </span><span class="WHIT">			</span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">909</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">910</span> </span><span class="WHIT">		</span><span class="NAME">htmlRows</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">textRows</span><span class="PUNC">[</span><span class="NAME">trCount</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">911</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">hrCount</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">hrCount</span><span class="PUNC">&lt;</span><span class="NAME">htmlRows.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">hrCount</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">912</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">hrCount</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">913</span> </span><span class="WHIT">				</span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">914</span> </span><span class="WHIT">				</span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">915</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">916</span> </span><span class="WHIT">			</span><span class="NAME">words</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">htmlRows</span><span class="PUNC">[</span><span class="NAME">hrCount</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#34; &#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">917</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">wCount</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">918</span> </span><span class="WHIT">			</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">wCount</span><span class="PUNC">&lt;</span><span class="NAME">words.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">919</span> </span><span class="WHIT">				</span><span class="NAME">calcDIV.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">920</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newLinePixels</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">calcDIV.offsetWidth</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">921</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newLinePixels</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">922</span> </span><span class="WHIT">					</span><span class="COMM">// whole &#34;words[wCount]&#34; won&#39;t fit on current &#34;newLine&#34; - insert line break, avoid incrementing &#34;wCount&#34;</span><span class="WHIT">
<span class="line">923</span> </span><span class="WHIT">					</span><span class="NAME">calcDIV.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">924</span> </span><span class="WHIT">					</span><span class="NAME">newLinePixels</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLinePixels</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">calcDIV.offsetWidth</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">925</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newLinePixels</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">calcDIV.offsetWidth</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">926</span> </span><span class="WHIT">						</span><span class="COMM">// either a) excess caused by &lt;space&gt; character or b) will fit completely on next line</span><span class="WHIT">
<span class="line">927</span> </span><span class="WHIT">						</span><span class="COMM">// so just break without incrementing &#34;wCount&#34; and append next time</span><span class="WHIT">
<span class="line">928</span> </span><span class="WHIT">						</span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">929</span> </span><span class="WHIT">						</span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">930</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">931</span> </span><span class="WHIT">					</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// must break &#34;words[wCount]&#34;</span><span class="WHIT">
<span class="line">932</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keepLooping</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">933</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">atPos</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">934</span> </span><span class="WHIT">						</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">keepLooping</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">935</span> </span><span class="WHIT">							</span><span class="NAME">atPos</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">936</span> </span><span class="WHIT">							</span><span class="NAME">calcDIV.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">atPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">937</span> </span><span class="WHIT">							</span><span class="NAME">keepLooping</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">calcDIV.offsetWidth</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">pixelWidth</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">938</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">939</span> </span><span class="WHIT">						</span><span class="NAME">atPos</span><span class="PUNC">--</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">940</span> </span><span class="WHIT">						</span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">atPos</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;br&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">941</span> </span><span class="WHIT">						</span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substr</span><span class="PUNC">(</span><span class="NAME">atPos</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">942</span> </span><span class="WHIT">						</span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">943</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">944</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// doesn&#39;t exceed pixelWidth, append to &#34;newLine&#34; and increment &#34;wCount&#34;</span><span class="WHIT">
<span class="line">945</span> </span><span class="WHIT">					</span><span class="NAME">newLine</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">words</span><span class="PUNC">[</span><span class="NAME">wCount</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">946</span> </span><span class="WHIT">					</span><span class="NAME">wCount</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">947</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">948</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">949</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">950</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">951</span> </span><span class="WHIT">	</span><span class="NAME">newString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newLine</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">952</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">newString</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">953</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">954</span> 
<span class="line">955</span> </span><span class="COMM">// Regexes for finding stuff in msg content</span><span class="WHIT">
<span class="line">956</span> </span><span class="NAME">AjxStringUtil.MSG_SEP_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^\\s*--+\\s*(&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.origMsg</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.forwardedMessage</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;)\\s*--+&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;i&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">957</span> </span><span class="NAME">AjxStringUtil.SIG_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/^(- ?-+)|(__+)\r?$/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">958</span> </span><span class="NAME">AjxStringUtil.SPLIT_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\r\n|\r|\n/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">959</span> </span><span class="NAME">AjxStringUtil.HDR_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/^\s*\w+:/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">960</span> </span><span class="NAME">AjxStringUtil.COLON_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\S+:$/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">961</span> 
<span class="line">962</span> </span><span class="COMM">// Converts a HTML document represented by a DOM tree to text</span><span class="WHIT">
<span class="line">963</span> </span><span class="COMM">// XXX: There has got to be a better way of doing this!</span><span class="WHIT">
<span class="line">964</span> </span><span class="NAME">AjxStringUtil._NO_LIST</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">965</span> </span><span class="NAME">AjxStringUtil._ORDERED_LIST</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">966</span> </span><span class="NAME">AjxStringUtil._UNORDERED_LIST</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">967</span> </span><span class="NAME">AjxStringUtil._INDENT</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;    &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">968</span> </span><span class="NAME">AjxStringUtil._NON_WHITESPACE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\S+/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">969</span> </span><span class="NAME">AjxStringUtil._LF</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\n/</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">970</span> 
<span class="line">971</span> </span><span class="NAME">AjxStringUtil.convertHtml2Text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">972</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">domRoot</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onlyOneNewLinePerP</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">973</span> 
<span class="line">974</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">domRoot</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">975</span> 
<span class="line">976</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">convertor</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">AjxUtil.isFunction</span><span class="PUNC">(</span><span class="NAME">convertor._before</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">977</span> </span><span class="WHIT">		</span><span class="NAME">domRoot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">convertor._before</span><span class="PUNC">(</span><span class="NAME">domRoot</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">978</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">979</span> 
<span class="line">980</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">domRoot</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;string&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">981</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">domNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;SPAN&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">982</span> </span><span class="WHIT">		</span><span class="NAME">domNode.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">domRoot</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">983</span> </span><span class="WHIT">		</span><span class="NAME">domRoot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">domNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">984</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">985</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">986</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">987</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">988</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._traverse</span><span class="PUNC">(</span><span class="NAME">domRoot</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._NO_LIST</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onlyOneNewLinePerP</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">989</span> 
<span class="line">990</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">991</span> 
<span class="line">992</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">convertor</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">AjxUtil.isFunction</span><span class="PUNC">(</span><span class="NAME">convertor._after</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">993</span> </span><span class="WHIT">		</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">convertor._after</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">994</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">995</span> 
<span class="line">996</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">997</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">998</span> 
<span class="line">999</span> </span><span class="NAME">AjxStringUtil._traverse</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1000</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listLevel</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">bulletNum</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onlyOneNewLinePerP</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1001</span> 
<span class="line">1002</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1003</span> 
<span class="line">1004</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1005</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">convertor</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">[</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1006</span> </span><span class="WHIT">		</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">[</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1007</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1008</span> 
<span class="line">1009</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1010</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1011</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;#text&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1012</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.nodeValue.search</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._NON_WHITESPACE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1013</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ctxt.lastNode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ol&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">ctxt.lastNode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ul&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1014</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1015</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1016</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ctxt.isPreformatted</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1017</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">el.nodeValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1018</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1019</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">el.nodeValue.replace</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._LF</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34; &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1020</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1021</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1022</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;p&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1023</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">onlyOneNewLinePerP</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;\n\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1024</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">listType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._NO_LIST</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;br&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;hr&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1025</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1026</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ol&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ul&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1027</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1028</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.parentNode.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;li&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">ctxt.lastNode</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;br&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">ctxt.lastNode</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;hr&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1029</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1030</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1031</span> </span><span class="WHIT">		</span><span class="NAME">listType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ol&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._ORDERED_LIST</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._UNORDERED_LIST</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1032</span> </span><span class="WHIT">		</span><span class="NAME">listLevel</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1033</span> </span><span class="WHIT">		</span><span class="NAME">bulletNum</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1034</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;li&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1035</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">listLevel</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1036</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._INDENT</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1037</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1038</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">listType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._ORDERED_LIST</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1039</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bulletNum</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;. &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1040</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1041</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\u002A &#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// TODO AjxMsg.bullet</span><span class="WHIT">
<span class="line">1042</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1043</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;tr&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.parentNode.firstChild</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1044</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1045</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;td&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.parentNode.firstChild</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1046</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\t&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1047</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;div&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;address&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1048</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1049</span> </span><span class="WHIT">            </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1050</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1051</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;blockquote&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1052</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1053</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;pre&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1054</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1055</span> </span><span class="WHIT">            </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1056</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1057</span> </span><span class="WHIT">		</span><span class="NAME">ctxt.isPreformatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1058</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;#comment&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">1059</span> </span><span class="WHIT">			   </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;script&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">1060</span> </span><span class="WHIT">			   </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;select&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">1061</span> </span><span class="WHIT">			   </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;style&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1062</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1063</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1064</span> 
<span class="line">1065</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.childNodes</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1066</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childNodes.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1067</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1068</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tmp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1069</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">tmp.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">tmp.tagName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;li&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1070</span> </span><span class="WHIT">			</span><span class="NAME">bulletNum</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1071</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1072</span> </span><span class="WHIT">		</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._traverse</span><span class="PUNC">(</span><span class="NAME">tmp</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listLevel</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">bulletNum</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onlyOneNewLinePerP</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1073</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1074</span> 
<span class="line">1075</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">convertor</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">[</span><span class="STRN">&#34;/&#34;</span><span class="PUNC">+</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1076</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">convertor</span><span class="PUNC">[</span><span class="STRN">&#34;/&#34;</span><span class="PUNC">+</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1077</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1078</span> 
<span class="line">1079</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h1&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h2&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h3&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h4&#34;</span><span class="WHIT">
<span class="line">1080</span> </span><span class="WHIT">		</span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h5&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;h6&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;div&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;address&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1081</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1082</span> </span><span class="WHIT">            </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1083</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1084</span> </span><span class="WHIT">			</span><span class="NAME">ctxt.list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1085</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;pre&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1086</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1087</span> </span><span class="WHIT">            </span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1088</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1089</span> </span><span class="WHIT">		</span><span class="NAME">ctxt.isPreformatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1090</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;li&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1091</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ctxt.list</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1092</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1093</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1094</span> </span><span class="WHIT">		</span><span class="NAME">ctxt.list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1095</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ol&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;ul&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1096</span> </span><span class="WHIT">		</span><span class="NAME">ctxt.list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1097</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;#text&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1098</span> </span><span class="WHIT">		</span><span class="NAME">ctxt.list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1099</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1100</span> 
<span class="line">1101</span> </span><span class="WHIT">	</span><span class="NAME">ctxt.lastNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1102</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1103</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1104</span> 
<span class="line">1105</span> </span><span class="COMM">/**
<span class="line">1106</span>  * Sets the given name/value pairs into the given query string. Args that appear
<span class="line">1107</span>  * in both will get the new value. The order of args in the returned query string
<span class="line">1108</span>  * is indeterminate.
<span class="line">1109</span>  *
<span class="line">1110</span>  * @param args		[hash]		name/value pairs to add to query string
<span class="line">1111</span>  * @param qsReset	[boolean]	if true, start with empty query string
<span class="line">1112</span>  * 
<span class="line">1113</span>  * @private
<span class="line">1114</span>  */</span><span class="WHIT">
<span class="line">1115</span> </span><span class="NAME">AjxStringUtil.queryStringSet</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1116</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">args</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">qsReset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1117</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qsReset</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">location.search</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1118</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">qs.indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;?&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1119</span> </span><span class="WHIT">		</span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.substr</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1120</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1121</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">qsArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.split</span><span class="PUNC">(</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1122</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1123</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">qsArgs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1124</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">f</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qsArgs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#34;=&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1125</span> </span><span class="WHIT">		</span><span class="NAME">newArgs</span><span class="PUNC">[</span><span class="NAME">f</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">f</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1126</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1127</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1128</span> </span><span class="WHIT">		</span><span class="NAME">newArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1129</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1130</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pairs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1131</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1132</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">newArgs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1133</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1134</span> </span><span class="WHIT">			</span><span class="NAME">pairs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;=&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1135</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1136</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1137</span> 
<span class="line">1138</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;?&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pairs.join</span><span class="PUNC">(</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1139</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1140</span> 
<span class="line">1141</span> </span><span class="COMM">/**
<span class="line">1142</span>  * Removes the given arg from the query string.
<span class="line">1143</span>  *
<span class="line">1144</span>  * @param {String}	qs	a query string
<span class="line">1145</span>  * @param {String}	name	the arg name
<span class="line">1146</span>  * 
<span class="line">1147</span>  * @return	{String}	the resulting query string
<span class="line">1148</span>  */</span><span class="WHIT">
<span class="line">1149</span> </span><span class="NAME">AjxStringUtil.queryStringRemove</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1150</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">qs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1151</span> </span><span class="WHIT">	</span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1152</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">qs.indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;?&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1153</span> </span><span class="WHIT">		</span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.substr</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1154</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1155</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pairs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.split</span><span class="PUNC">(</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1156</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pairs1</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1157</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">pairs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1158</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">pairs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">indexOf</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1159</span> </span><span class="WHIT">			</span><span class="NAME">pairs1.push</span><span class="PUNC">(</span><span class="NAME">pairs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1160</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1161</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1162</span> 
<span class="line">1163</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;?&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pairs1.join</span><span class="PUNC">(</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1164</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1165</span> 
<span class="line">1166</span> </span><span class="COMM">/**
<span class="line">1167</span>  * Returns the given object/primitive as a string.
<span class="line">1168</span>  *
<span class="line">1169</span>  * @param {primitive|Object}	o		an object or primitive
<span class="line">1170</span>  * @return	{String}	the string
<span class="line">1171</span>  */</span><span class="WHIT">
<span class="line">1172</span> </span><span class="NAME">AjxStringUtil.getAsString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1173</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">o</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1174</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">o</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">o</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;object&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">o.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">o</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1175</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1176</span> 
<span class="line">1177</span> </span><span class="NAME">AjxStringUtil.isWhitespace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> 
<span class="line">1178</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1179</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">str.charCodeAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">32</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1180</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1181</span> 
<span class="line">1182</span> </span><span class="NAME">AjxStringUtil.isDigit</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> 
<span class="line">1183</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1184</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">charCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.charCodeAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1185</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">charCode</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NUMB">48</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">charCode</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">57</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1186</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1187</span> 
<span class="line">1188</span> </span><span class="NAME">AjxStringUtil.compareRight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> 
<span class="line">1189</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">,</span><span class="NAME">b</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1190</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bias</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1191</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idxa</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1192</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idxb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1193</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ca</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1194</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1195</span> 
<span class="line">1196</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idxa</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">a.length</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">idxb</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">b.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idxa</span><span class="PUNC">++</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idxb</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1197</span> </span><span class="WHIT">		</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.charAt</span><span class="PUNC">(</span><span class="NAME">idxa</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1198</span> </span><span class="WHIT">		</span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">b.charAt</span><span class="PUNC">(</span><span class="NAME">idxb</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1199</span> 
<span class="line">1200</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">ca</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT">
<span class="line">1201</span> </span><span class="WHIT">			</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">cb</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1202</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1203</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">bias</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1204</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1205</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">ca</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1206</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1207</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1208</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1209</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">cb</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1210</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1211</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1212</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1213</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1214</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1215</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bias</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">bias</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1216</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1217</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1218</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1219</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">bias</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">bias</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1220</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1221</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1222</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1223</span> 
<span class="line">1224</span> </span><span class="NAME">AjxStringUtil.natCompare</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> 
<span class="line">1225</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">b</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1226</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idxa</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idxb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1227</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nza</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nzb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1228</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ca</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1229</span> 
<span class="line">1230</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idxa</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">a.length</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">idxb</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">b.length</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1231</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1232</span> </span><span class="WHIT">		</span><span class="COMM">// number of zeroes leading the last number compared</span><span class="WHIT">
<span class="line">1233</span> </span><span class="WHIT">		</span><span class="NAME">nza</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nzb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1234</span> 
<span class="line">1235</span> </span><span class="WHIT">		</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.charAt</span><span class="PUNC">(</span><span class="NAME">idxa</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1236</span> </span><span class="WHIT">		</span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">b.charAt</span><span class="PUNC">(</span><span class="NAME">idxb</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1237</span> 
<span class="line">1238</span> </span><span class="WHIT">		</span><span class="COMM">// ignore overleading spaces/zeros and move the index accordingly</span><span class="WHIT">
<span class="line">1239</span> </span><span class="WHIT">		</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.isWhitespace</span><span class="PUNC">(</span><span class="NAME">ca</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="STRN">&#39;0&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1240</span> </span><span class="WHIT">			</span><span class="NAME">nza</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;0&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nza</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1241</span> </span><span class="WHIT">			</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">a.charAt</span><span class="PUNC">(</span><span class="PUNC">++</span><span class="NAME">idxa</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1242</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1243</span> </span><span class="WHIT">		</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.isWhitespace</span><span class="PUNC">(</span><span class="NAME">cb</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;0&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1244</span> </span><span class="WHIT">			</span><span class="NAME">nzb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;0&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nzb</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1245</span> </span><span class="WHIT">			</span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">b.charAt</span><span class="PUNC">(</span><span class="PUNC">++</span><span class="NAME">idxb</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1246</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1247</span> 
<span class="line">1248</span> </span><span class="WHIT">		</span><span class="COMM">// current index points to digit in both str</span><span class="WHIT">
<span class="line">1249</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">ca</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.isDigit</span><span class="PUNC">(</span><span class="NAME">cb</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1250</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.compareRight</span><span class="PUNC">(</span><span class="NAME">a.substring</span><span class="PUNC">(</span><span class="NAME">idxa</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">b.substring</span><span class="PUNC">(</span><span class="NAME">idxb</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1251</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">!=</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1252</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1253</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1254</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1255</span> 
<span class="line">1256</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1257</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nza</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">nzb</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1258</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1259</span> 
<span class="line">1260</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1261</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1262</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ca</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">cb</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1263</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1264</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1265</span> 
<span class="line">1266</span> </span><span class="WHIT">		</span><span class="PUNC">++</span><span class="NAME">idxa</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">idxb</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1267</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1268</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1269</span> 
<span class="line">1270</span> </span><span class="NAME">AjxStringUtil.clipFile</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1271</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">fileName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">limit</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1272</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fileName.lastIndexOf</span><span class="PUNC">(</span><span class="STRN">&#39;.&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1273</span> 
<span class="line">1274</span> </span><span class="WHIT">	</span><span class="COMM">// fallback - either not found or starts with delimiter</span><span class="WHIT">
<span class="line">1275</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1276</span> </span><span class="WHIT">		</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fileName.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1277</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1278</span> 
<span class="line">1279</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">limit</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1280</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fileName</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1281</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1282</span> 
<span class="line">1283</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fileName.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1284</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ext</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fileName.slice</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1285</span> 
<span class="line">1286</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class="line">1287</span> </span><span class="WHIT">		</span><span class="NAME">fName.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">limit</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1288</span> </span><span class="WHIT">		</span><span class="NAME">AjxMsg.ellipsis</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1289</span> </span><span class="WHIT">		</span><span class="NAME">fName.slice</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NAME">Math.ceil</span><span class="PUNC">(</span><span class="NAME">limit</span><span class="PUNC">/</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.ellipsis.length</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1290</span> </span><span class="WHIT">		</span><span class="NAME">ext</span><span class="WHIT">
<span class="line">1291</span> </span><span class="WHIT">	</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1292</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1293</span> 
<span class="line">1294</span> 
<span class="line">1295</span> </span><span class="NAME">AjxStringUtil.URL_PARSE_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^(?:([^:/?#.]+):)?(?://)?(([^:/?#]*)(?::(\\d*))?)?((/(?:[^?#](?![^?#/]*\\.[^?#/.]+(?:[\\?#]|$)))*/?)?([^?#/]*))?(?:\\?([^#]*))?(?:#(.*))?&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1296</span> 
<span class="line">1297</span> </span><span class="NAME">AjxStringUtil.parseURL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> 
<span class="line">1298</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">sourceUri</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1299</span> 
<span class="line">1300</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">names</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">&#34;source&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;protocol&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;authority&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;domain&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;port&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;path&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;directoryPath&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;fileName&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;query&#34;</span><span class="PUNC">,</span><span class="STRN">&#34;anchor&#34;</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1301</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.URL_PARSE_RE.exec</span><span class="PUNC">(</span><span class="NAME">sourceUri</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1302</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">uri</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1303</span> 
<span class="line">1304</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">names.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1305</span> </span><span class="WHIT">		</span><span class="NAME">uri</span><span class="PUNC">[</span><span class="NAME">names</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1306</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1307</span> 
<span class="line">1308</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">uri.directoryPath.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1309</span> </span><span class="WHIT">		</span><span class="NAME">uri.directoryPath</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">uri.directoryPath.replace</span><span class="PUNC">(</span><span class="REGX">/\/?$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;/&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1310</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1311</span> 
<span class="line">1312</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">uri</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1313</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1314</span> 
<span class="line">1315</span> </span><span class="COMM">/**
<span class="line">1316</span>  * Parses a mailto: link into components. If the string is not a mailto: link, the object returned will
<span class="line">1317</span>  * have a &#34;to&#34; property set to the string.
<span class="line">1318</span>  *
<span class="line">1319</span>  * @param {String}      str     email address, possibly within a &#34;mailto:&#34; link
<span class="line">1320</span>  * @returns {Object}    object with at least a &#39;to&#39; property, and possibly &#39;subject&#39; and &#39;body&#39;
<span class="line">1321</span>  */</span><span class="WHIT">
<span class="line">1322</span> </span><span class="NAME">AjxStringUtil.parseMailtoLink</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1323</span> 
<span class="line">1324</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1325</span> 
<span class="line">1326</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1327</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1328</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1329</span> 
<span class="line">1330</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">str.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">indexOf</span><span class="PUNC">(</span><span class="STRN">&#39;mailto:&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1331</span> </span><span class="WHIT">		</span><span class="NAME">parts.to</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1332</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1333</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1334</span> 
<span class="line">1335</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.match</span><span class="PUNC">(</span><span class="REGX">/\bsubject=([^&amp;]+)/i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1336</span> </span><span class="WHIT">	</span><span class="NAME">parts.subject</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">match</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1337</span> 
<span class="line">1338</span> </span><span class="WHIT">	</span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.match</span><span class="PUNC">(</span><span class="REGX">/\bto\:([^&amp;]+)/</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1339</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">match</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1340</span> </span><span class="WHIT">		</span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.match</span><span class="PUNC">(</span><span class="REGX">/\bmailto\:([^\?]+)/i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1341</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1342</span> </span><span class="WHIT">	</span><span class="NAME">parts.to</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">match</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1343</span> 
<span class="line">1344</span> </span><span class="WHIT">	</span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.match</span><span class="PUNC">(</span><span class="REGX">/\bbody=([^&amp;]+)/i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1345</span> </span><span class="WHIT">	</span><span class="NAME">parts.body</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">match</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1346</span> 
<span class="line">1347</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">parts</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1348</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1349</span> 
<span class="line">1350</span> </span><span class="COMM">/**
<span class="line">1351</span>  * Parse the query string (part after the &#34;?&#34;) and return it as a hash of key/value pairs.
<span class="line">1352</span>  * 
<span class="line">1353</span>  * @param	{String}	sourceUri		the source location or query string
<span class="line">1354</span>  * @return	{Object}	a hash of query string params
<span class="line">1355</span>  */</span><span class="WHIT">
<span class="line">1356</span> </span><span class="NAME">AjxStringUtil.parseQueryString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1357</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">sourceUri</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1358</span> 
<span class="line">1359</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">location</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sourceUri</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">window.location</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1360</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">location.indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;?&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1361</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">location</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">location.substring</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1362</span> </span><span class="WHIT">	</span><span class="NAME">qs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.replace</span><span class="PUNC">(</span><span class="REGX">/#.*$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">    </span><span class="COMM">// strip anchor</span><span class="WHIT">
<span class="line">1363</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">qs.split</span><span class="PUNC">(</span><span class="STRN">&#34;&amp;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1364</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">params</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pair</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1365</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">list.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1366</span> </span><span class="WHIT">		</span><span class="NAME">pair</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">list</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#34;=&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1367</span> </span><span class="WHIT">		</span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">pair</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1368</span> </span><span class="WHIT">		</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pair</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">decodeURIComponent</span><span class="PUNC">(</span><span class="NAME">pair</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">   </span><span class="COMM">// if no value given, set to true so we know it&#39;s there</span><span class="WHIT">
<span class="line">1369</span> </span><span class="WHIT">		</span><span class="NAME">params</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1370</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1371</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1372</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1373</span> 
<span class="line">1374</span> </span><span class="COMM">/**
<span class="line">1375</span>  * Pretty-prints a JS object. Preferred over JSON.stringify for the debug-related dumping
<span class="line">1376</span>  * of an object for several reasons:
<span class="line">1377</span>  * 		- doesn&#39;t have an enclosing object, which shifts everything over one level
<span class="line">1378</span>  * 		- doesn&#39;t put quotes around keys
<span class="line">1379</span>  * 		- shows indexes for arrays (downside is that prevents output from being eval-able)
<span class="line">1380</span>  * 
<span class="line">1381</span>  * @param obj
<span class="line">1382</span>  * @param recurse
<span class="line">1383</span>  * @param showFuncs
<span class="line">1384</span>  * @param omit
<span class="line">1385</span>  */</span><span class="WHIT">
<span class="line">1386</span> </span><span class="NAME">AjxStringUtil.prettyPrint</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1387</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recurse</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">showFuncs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1388</span> 
<span class="line">1389</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._visited</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">AjxVector</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1390</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._prettyPrint</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recurse</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">showFuncs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1391</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._visited</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1392</span> 
<span class="line">1393</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1394</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1395</span> 
<span class="line">1396</span> </span><span class="NAME">AjxStringUtil._visited</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1397</span> 
<span class="line">1398</span> </span><span class="NAME">AjxStringUtil._prettyPrint</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1399</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recurse</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">showFuncs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1400</span> 
<span class="line">1401</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">indentLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1402</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">showBraces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1403</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stopRecursion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1404</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1405</span> </span><span class="WHIT">		</span><span class="NAME">indentLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NUMB">4</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1406</span> </span><span class="WHIT">		</span><span class="NAME">showBraces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NUMB">5</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1407</span> </span><span class="WHIT">		</span><span class="NAME">stopRecursion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NUMB">6</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1408</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1409</span> 
<span class="line">1410</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isObject</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1411</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">objStr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">obj.toString</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">obj.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1412</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">omit</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">objStr</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">[</span><span class="NAME">objStr</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1413</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;[&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">objStr</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1414</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1415</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._visited.contains</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1416</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;[visited object]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1417</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1418</span> </span><span class="WHIT">			</span><span class="NAME">AjxStringUtil._visited.add</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1419</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1420</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1421</span> 
<span class="line">1422</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">indent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.repeat</span><span class="PUNC">(</span><span class="STRN">&#34; &#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentLevel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1423</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1424</span> 
<span class="line">1425</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">obj</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1426</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;[undefined]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1427</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">obj</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1428</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;[null]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1429</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isBoolean</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1430</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">obj</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;true&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;false&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1431</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isString</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1432</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._escapeForHTML</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1433</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isNumber</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1434</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">obj</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1435</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isObject</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1436</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxUtil.isArray</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxUtil.isArray1</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1437</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">stopRecursion</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1438</span> </span><span class="WHIT">			</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;[Array]&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">obj.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1439</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1440</span> </span><span class="WHIT">			</span><span class="NAME">stopRecursion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">recurse</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1441</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1442</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">obj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1443</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">obj.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1444</span> </span><span class="WHIT">                    </span><span class="NAME">keys.push</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1445</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1446</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1447</span> 
<span class="line">1448</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1449</span> </span><span class="WHIT">				</span><span class="NAME">keys.sort</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">,</span><span class="NAME">b</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">b</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1450</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1451</span> </span><span class="WHIT">				</span><span class="NAME">keys.sort</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1452</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1453</span> 
<span class="line">1454</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">showBraces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1455</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;[&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;{&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1456</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1457</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1458</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1459</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1460</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nextObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">obj</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1461</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1462</span> </span><span class="WHIT">				</span><span class="COMM">// For dumping events, and dom elements, though I may not want to</span><span class="WHIT">
<span class="line">1463</span> </span><span class="WHIT">				</span><span class="COMM">// traverse the node, I do want to know what the attribute is.</span><span class="WHIT">
<span class="line">1464</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nextObj</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">window</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">nextObj</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">document</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxEnv.isIE</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">nextObj</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Node</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1465</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nextObj.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1466</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1467</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">nextObj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#34;function&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1468</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">showFuncs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1469</span> </span><span class="WHIT">						</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;[function]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1470</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1471</span> </span><span class="WHIT">						</span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1472</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1473</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1474</span> 
<span class="line">1475</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1476</span> </span><span class="WHIT">					</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;,&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1477</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1478</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">indent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1479</span> </span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyString</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1480</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1481</span> </span><span class="WHIT">                    </span><span class="NAME">keyString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;// [&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;]:\n&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">indent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1482</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1483</span> </span><span class="WHIT">                    </span><span class="NAME">keyString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;: &#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1484</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1485</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">omit</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1486</span> </span><span class="WHIT">					</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keyString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;[&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;]&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1487</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1488</span> </span><span class="WHIT">					</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keyString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1489</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1490</span> </span><span class="WHIT">					</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keyString</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._prettyPrint</span><span class="PUNC">(</span><span class="NAME">nextObj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recurse</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">showFuncs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">omit</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentLevel</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stopRecursion</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1491</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1492</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1493</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1494</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.repeat</span><span class="PUNC">(</span><span class="STRN">&#34; &#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentLevel</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1495</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1496</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">showBraces</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1497</span> </span><span class="WHIT">				</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;]&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#34;}&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1498</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1499</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1500</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1501</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1502</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1503</span> 
<span class="line">1504</span> </span><span class="NAME">AjxStringUtil._escapeForHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1505</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1506</span> 
<span class="line">1507</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#39;string&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1508</span> 
<span class="line">1509</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1510</span> </span><span class="WHIT">	</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">s.replace</span><span class="PUNC">(</span><span class="REGX">/\&amp;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&amp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1511</span> </span><span class="WHIT">	</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">s.replace</span><span class="PUNC">(</span><span class="REGX">/\&lt;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1512</span> </span><span class="WHIT">	</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">s.replace</span><span class="PUNC">(</span><span class="REGX">/\&gt;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1513</span> </span><span class="WHIT">	</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">s.replace</span><span class="PUNC">(</span><span class="REGX">/\&#34;/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#34;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1514</span> </span><span class="WHIT">	</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">s.replace</span><span class="PUNC">(</span><span class="REGX">/\xA0/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1515</span> 
<span class="line">1516</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1517</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1518</span> 
<span class="line">1519</span> </span><span class="COMM">// hidden SPANs for measuring regular and bold strings</span><span class="WHIT">
<span class="line">1520</span> </span><span class="NAME">AjxStringUtil._testSpan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1521</span> </span><span class="NAME">AjxStringUtil._testSpanBold</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1522</span> 
<span class="line">1523</span> </span><span class="COMM">// cached string measurements</span><span class="WHIT">
<span class="line">1524</span> </span><span class="NAME">AjxStringUtil.WIDTH</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="COMM">// regular strings</span><span class="WHIT">
<span class="line">1525</span> </span><span class="NAME">AjxStringUtil.WIDTH_BOLD</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="COMM">// bold strings</span><span class="WHIT">
<span class="line">1526</span> </span><span class="NAME">AjxStringUtil.MAX_CACHE</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1000</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="COMM">// max total number of cached strings</span><span class="WHIT">
<span class="line">1527</span> </span><span class="NAME">AjxStringUtil._cacheSize</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">		</span><span class="COMM">// current number of cached strings</span><span class="WHIT">
<span class="line">1528</span> 
<span class="line">1529</span> </span><span class="COMM">/**
<span class="line">1530</span>  * Returns the width in pixels of the given string.
<span class="line">1531</span>  *
<span class="line">1532</span>  * @param {string}	str		string to measure
<span class="line">1533</span>  * @param {boolean}	bold	if true, string should be measured in bold font
<span class="line">1534</span>  * @param {string|number}   font size to measure string in. If unset, use default font size
<span class="line">1535</span>  */</span><span class="WHIT">
<span class="line">1536</span> </span><span class="NAME">AjxStringUtil.getWidth</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1537</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">bold</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fontSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1538</span> 
<span class="line">1539</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil._testSpan</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1540</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">span1</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._testSpan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;SPAN&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1541</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">span2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._testSpanBold</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;SPAN&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1542</span> </span><span class="WHIT">		</span><span class="NAME">span1.style.position</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">span2.style.position</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Dwt.ABSOLUTE_STYLE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1543</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shellEl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">DwtShell.getShell</span><span class="PUNC">(</span><span class="NAME">window</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getHtmlElement</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1544</span> </span><span class="WHIT">		</span><span class="NAME">shellEl.appendChild</span><span class="PUNC">(</span><span class="NAME">span1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1545</span> </span><span class="WHIT">		</span><span class="NAME">shellEl.appendChild</span><span class="PUNC">(</span><span class="NAME">span2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1546</span> </span><span class="WHIT">		</span><span class="NAME">Dwt.setLocation</span><span class="PUNC">(</span><span class="NAME">span1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1547</span> </span><span class="WHIT">		</span><span class="NAME">Dwt.setLocation</span><span class="PUNC">(</span><span class="NAME">span2</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1548</span> </span><span class="WHIT">		</span><span class="NAME">span2.style.fontWeight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;bold&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1549</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1550</span> 
<span class="line">1551</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxUtil.isString</span><span class="PUNC">(</span><span class="NAME">fontSize</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1552</span> </span><span class="WHIT">		</span><span class="NAME">fontSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">DwtCssStyle.asPixelCount</span><span class="PUNC">(</span><span class="NAME">fontSize</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1553</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1554</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sz</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fontSize</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// 0 means &#34;default&#34;;</span><span class="WHIT">
<span class="line">1555</span> </span><span class="WHIT">	
<span class="line">1556</span> 	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bold</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.WIDTH_BOLD</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.WIDTH</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1557</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">sz</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1558</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">sz</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1559</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1560</span> 
<span class="line">1561</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._cacheSize</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.MAX_CACHE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1562</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil.WIDTH</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1563</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil.WIDTH_BOLD</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1564</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._cacheSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1565</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1566</span> 
<span class="line">1567</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">span</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bold</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._testSpanBold</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._testSpan</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1568</span> </span><span class="WHIT">	</span><span class="NAME">span.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1569</span> </span><span class="WHIT">	</span><span class="NAME">span.style.fontSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fontSize</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fontSize</span><span class="PUNC">+</span><span class="STRN">&#34;px&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1570</span> 
<span class="line">1571</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1572</span> </span><span class="WHIT">		</span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1573</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1574</span> 
<span class="line">1575</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">w</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">str</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">sz</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Dwt.getSize</span><span class="PUNC">(</span><span class="NAME">span</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">x</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1576</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._cacheSize</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1577</span> 
<span class="line">1578</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">w</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1579</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1580</span> 
<span class="line">1581</span> </span><span class="COMM">/**
<span class="line">1582</span>  * correct the cross domain reference in passed url content
<span class="line">1583</span>  * eg: http://&lt;ipaddress&gt;/ url might have rest url page which points to http://&lt;server name&gt;/ pages
<span class="line">1584</span>  *
<span class="line">1585</span>  */</span><span class="WHIT">
<span class="line">1586</span> </span><span class="NAME">AjxStringUtil.fixCrossDomainReference</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1587</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">restUrlAuthority</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">convertToRelativeURL</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1588</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">urlParts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.parseURL</span><span class="PUNC">(</span><span class="NAME">url</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1589</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">urlParts.authority</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">window.location.host</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1590</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1591</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1592</span> 
<span class="line">1593</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">restUrlAuthority</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">url.indexOf</span><span class="PUNC">(</span><span class="NAME">restUrlAuthority</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">restUrlAuthority</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1594</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">convertToRelativeURL</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1595</span> </span><span class="WHIT">            </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">urlParts.path</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1596</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1597</span> </span><span class="WHIT">        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1598</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oldRef</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">urlParts.protocol</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;://&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">urlParts.authority</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1599</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newRef</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.location.protocol</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;//&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">window.location.host</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1600</span> </span><span class="WHIT">            </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">url.replace</span><span class="PUNC">(</span><span class="NAME">oldRef</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newRef</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1601</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1602</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1603</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1604</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1605</span> 
<span class="line">1606</span> 
<span class="line">1607</span> </span><span class="NAME">AjxStringUtil._dummyDiv</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;DIV&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1608</span> 
<span class="line">1609</span> </span><span class="NAME">AjxStringUtil.htmlPlatformIndependent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1610</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1611</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">div</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._dummyDiv</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1612</span> </span><span class="WHIT">	</span><span class="NAME">div.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1613</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">inner</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">div.innerHTML</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1614</span> </span><span class="WHIT">	</span><span class="NAME">div.innerHTML</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1615</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">inner</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1616</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1617</span> 
<span class="line">1618</span> </span><span class="COMM">/**
<span class="line">1619</span>  * compare two html code fragments, ignoring the case of tags, since the tags inside innnerHTML are returned differently by different browsers (and from Outlook)
<span class="line">1620</span>  * e.g. IE returns CAPS for tag names in innerHTML while FF returns lowercase tag names. Outlook signature creation also returns lowercase.
<span class="line">1621</span>  * this approach is also good in case the browser removes some of the innerHTML set to it, like I suspect might be in the case of stuff coming from Outlook. (e.g. it removes head tag since it&#39;s illegal inside a div)
<span class="line">1622</span>  *
<span class="line">1623</span>  * @param html1
<span class="line">1624</span>  * @param html2
<span class="line">1625</span>  */</span><span class="WHIT">
<span class="line">1626</span> </span><span class="NAME">AjxStringUtil.equalsHtmlPlatformIndependent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1627</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">html2</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1628</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.htmlPlatformIndependent</span><span class="PUNC">(</span><span class="NAME">html1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.htmlPlatformIndependent</span><span class="PUNC">(</span><span class="NAME">html2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1629</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1630</span> 
<span class="line">1631</span> </span><span class="COMM">// Stuff for parsing messages to find original (as opposed to quoted) content</span><span class="WHIT">
<span class="line">1632</span> 
<span class="line">1633</span> </span><span class="COMM">// types of content related to finding original content; not all are used</span><span class="WHIT">
<span class="line">1634</span> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;UNKNOWN&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1635</span> </span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;QUOTED&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1636</span> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;SEP_STRONG&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1637</span> </span><span class="NAME">AjxStringUtil.ORIG_SEP_WEAK</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;SEP_WEAK&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1638</span> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;WROTE_STRONG&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1639</span> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_WEAK</span><span class="WHIT">	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;WROTE_WEAK&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1640</span> </span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;HEADER&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1641</span> </span><span class="NAME">AjxStringUtil.ORIG_LINE</span><span class="WHIT">			</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;LINE&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1642</span> </span><span class="NAME">AjxStringUtil.ORIG_SIG_SEP</span><span class="WHIT">		</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;SIG_SEP&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1643</span> 
<span class="line">1644</span> </span><span class="COMM">// regexes for parsing msg body content so we can figure out what was quoted and what&#39;s new</span><span class="WHIT">
<span class="line">1645</span> </span><span class="COMM">// TODO: should these be moved to AjxMsg to be fully localizable?</span><span class="WHIT">
<span class="line">1646</span> </span><span class="NAME">AjxStringUtil.MSG_REGEXES</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class="line">1647</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1648</span> </span><span class="WHIT">		</span><span class="COMM">// the two most popular quote characters, &gt; and |</span><span class="WHIT">
<span class="line">1649</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1650</span> </span><span class="WHIT">		</span><span class="NAME">regex</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="REGX">/^\s*(&gt;|\|)/</span><span class="WHIT">
<span class="line">1651</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1652</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1653</span> </span><span class="WHIT">		</span><span class="COMM">// marker for Original or Forwarded message, used by ZCS and others</span><span class="WHIT">
<span class="line">1654</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1655</span> </span><span class="WHIT">		</span><span class="NAME">regex</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^\\s*--+\\s*(&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.origMsg</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.forwardedMessage</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.origAppt</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;)\\s*--+\\s*$&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;i&#34;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1656</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1657</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1658</span> </span><span class="WHIT">		</span><span class="COMM">// marker for Original or Forwarded message, used by ZCS and others</span><span class="WHIT">
<span class="line">1659</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1660</span> </span><span class="WHIT">		</span><span class="NAME">regex</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.forwardedMessage1</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;$&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;i&#34;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1661</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1662</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1663</span> </span><span class="WHIT">		</span><span class="COMM">// one of the commonly quoted email headers</span><span class="WHIT">
<span class="line">1664</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1665</span> </span><span class="WHIT">		</span><span class="NAME">regex</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^\\s*(&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">AjxMsg.from</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxMsg.to</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxMsg.subject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxMsg.date</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxMsg.sent</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">AjxMsg.cc</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34;|&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;)&#34;</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">1666</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1667</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1668</span> </span><span class="WHIT">		</span><span class="COMM">// some clients use a series of underscores as a text-mode separator (text version of &lt;hr&gt;)</span><span class="WHIT">
<span class="line">1669</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">AjxStringUtil.ORIG_LINE</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">1670</span> </span><span class="WHIT">		</span><span class="NAME">regex</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="REGX">/^\s*_{5,}\s*$/</span><span class="WHIT">
<span class="line">1671</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="COMM">/*,
<span class="line">1672</span> 	{
<span class="line">1673</span> 		// in case a client doesn&#39;t use the exact words above
<span class="line">1674</span> 		type:	AjxStringUtil.ORIG_SEP_WEAK,
<span class="line">1675</span> 		regex:	/^\s*--+\s*[\w\s]+\s*--+$/
<span class="line">1676</span> 	},
<span class="line">1677</span> 	{
<span class="line">1678</span> 		// internet style signature separator
<span class="line">1679</span> 		type:	AjxStringUtil.ORIG_SIG_SEP,
<span class="line">1680</span> 		regex:	/^- ?-\s*$/
<span class="line">1681</span> 	}*/</span><span class="WHIT">
<span class="line">1682</span> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1683</span> 
<span class="line">1684</span> </span><span class="COMM">// ID for an HR to mark it as ours</span><span class="WHIT">
<span class="line">1685</span> </span><span class="NAME">AjxStringUtil.HTML_SEP_ID</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;zwchr&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1686</span> 
<span class="line">1687</span> </span><span class="COMM">// regexes for finding a delimiter such as &#34;On DATE, NAME (EMAIL) wrote:&#34;</span><span class="WHIT">
<span class="line">1688</span> </span><span class="NAME">AjxStringUtil.ORIG_EMAIL_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/[^@\s]+@[A-Za-z0-9\-]{2,}(\.[A-Za-z0-9\-]{2,})+/</span><span class="PUNC">;</span><span class="WHIT">    </span><span class="COMM">// see AjxUtil.EMAIL_FULL_RE</span><span class="WHIT">
<span class="line">1689</span> </span><span class="NAME">AjxStringUtil.ORIG_DATE_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/\d+\s*(\/|\-|, )20\d\d/</span><span class="PUNC">;</span><span class="WHIT">                                    </span><span class="COMM">// matches &#34;03/07/2014&#34; or &#34;March 3, 2014&#34; by looking for year 20xx</span><span class="WHIT">
<span class="line">1690</span> </span><span class="NAME">AjxStringUtil.ORIG_INTRO_RE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^(-{2,}|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.on</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;\\s+)&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;i&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1691</span> 
<span class="line">1692</span> 
<span class="line">1693</span> </span><span class="COMM">// Lazily creates a test hidden IFRAME and writes the given html to it, then returns the HTML element.</span><span class="WHIT">
<span class="line">1694</span> </span><span class="NAME">AjxStringUtil._writeToTestIframeDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1695</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1696</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">iframe</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1697</span> 
<span class="line">1698</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.__curIframeId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1699</span> </span><span class="WHIT">		</span><span class="NAME">iframe</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.createElement</span><span class="PUNC">(</span><span class="STRN">&#34;IFRAME&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1700</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil.__curIframeId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">iframe.id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Dwt.getNextId</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1701</span> </span><span class="WHIT">		
<span class="line">1702</span> 		</span><span class="COMM">// position offscreen rather than set display:none so we can get metrics if needed; no perf difference seen</span><span class="WHIT">
<span class="line">1703</span> </span><span class="WHIT">		</span><span class="NAME">Dwt.setPosition</span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.ABSOLUTE_STYLE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1704</span> </span><span class="WHIT">		</span><span class="NAME">Dwt.setLocation</span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Dwt.LOC_NOWHERE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1705</span> </span><span class="WHIT">		</span><span class="NAME">iframe.setAttribute</span><span class="PUNC">(</span><span class="STRN">&#39;aria-hidden&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1706</span> </span><span class="WHIT">		</span><span class="NAME">document.body.appendChild</span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1707</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1708</span> </span><span class="WHIT">		</span><span class="NAME">iframe</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.__curIframeId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1709</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1710</span> 
<span class="line">1711</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">idoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Dwt.getIframeDoc</span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1712</span> 
<span class="line">1713</span> </span><span class="WHIT">    </span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.IMG_SRC_CID_REGEX</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;img $1 pnsrc=&#34;cid:&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1714</span> </span><span class="WHIT">	</span><span class="NAME">idoc.open</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1715</span> </span><span class="WHIT">	</span><span class="NAME">idoc.write</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1716</span> </span><span class="WHIT">	</span><span class="NAME">idoc.close</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1717</span> 
<span class="line">1718</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">idoc.childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1719</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1720</span> 
<span class="line">1721</span> </span><span class="COMM">// Firefox only - clean up test iframe since we can&#39;t reuse it</span><span class="WHIT">
<span class="line">1722</span> </span><span class="NAME">AjxStringUtil._removeTestIframeDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1723</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1724</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxEnv.isFirefox</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1725</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">iframe</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">document.getElementById</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.__curIframeId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1726</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1727</span> </span><span class="WHIT">			</span><span class="NAME">iframe.parentNode.removeChild</span><span class="PUNC">(</span><span class="NAME">iframe</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1728</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1729</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil.__curIframeId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1730</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1731</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1732</span> 
<span class="line">1733</span> </span><span class="COMM">/**
<span class="line">1734</span>  * Analyze the text and return what appears to be original (as opposed to quoted) content. We
<span class="line">1735</span>  * look for separators commonly used by mail clients, as well as prefixes that indicate that
<span class="line">1736</span>  * a line is being quoted.
<span class="line">1737</span>  * 
<span class="line">1738</span>  * @param {string}	text		message body content
<span class="line">1739</span>  * 
<span class="line">1740</span>  * @return	{string}	original content if quoted content was found, otherwise NULL
<span class="line">1741</span>  */</span><span class="WHIT">
<span class="line">1742</span> </span><span class="NAME">AjxStringUtil.getOriginalContent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1743</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isHtml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1744</span> </span><span class="WHIT">	
<span class="line">1745</span> 	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">text</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1746</span> </span><span class="WHIT">	
<span class="line">1747</span> 	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isHtml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1748</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getOriginalHtmlContent</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1749</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1750</span> 
<span class="line">1751</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1752</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.split</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.SPLIT_RE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1753</span> </span><span class="WHIT">	
<span class="line">1754</span> 	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">curType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">curBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">count</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isMerged</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">unknownBlock</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isBugzilla</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1755</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">lines.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1756</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1757</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">testLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1758</span> 
<span class="line">1759</span> </span><span class="WHIT">		</span><span class="COMM">// blank lines are just added to the current block</span><span class="WHIT">
<span class="line">1760</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1761</span> </span><span class="WHIT">			</span><span class="NAME">curBlock.push</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1762</span> </span><span class="WHIT">			</span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1763</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1764</span> </span><span class="WHIT">		
<span class="line">1765</span> 		</span><span class="COMM">// Bugzilla summary looks like QUOTED; it should be treated as UNKNOWN</span><span class="WHIT">
<span class="line">1766</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">testLine.indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;| DO NOT REPLY&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;bugzilla&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1767</span> </span><span class="WHIT">			</span><span class="NAME">isBugzilla</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1768</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1769</span> 
<span class="line">1770</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1771</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1772</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isBugzilla</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1773</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1774</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1775</span> </span><span class="WHIT">			</span><span class="NAME">isBugzilla</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1776</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1777</span> 
<span class="line">1778</span> </span><span class="WHIT">		</span><span class="COMM">// WROTE can stretch over two lines; if so, join them into one line</span><span class="WHIT">
<span class="line">1779</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nextLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1780</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isMerged</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1781</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nextLine</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_INTRO_RE.test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">nextLine.match</span><span class="PUNC">(</span><span class="REGX">/\w+:$/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1782</span> </span><span class="WHIT">			</span><span class="NAME">testLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">testLine</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nextLine</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">&#34; &#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1783</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1784</span> </span><span class="WHIT">			</span><span class="NAME">isMerged</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1785</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1786</span> </span><span class="WHIT">		
<span class="line">1787</span> 		</span><span class="COMM">// LINE sometimes used as delimiter; if HEADER follows, lump it in with them</span><span class="WHIT">
<span class="line">1788</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_LINE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1789</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1790</span> </span><span class="WHIT">			</span><span class="NAME">nextLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1791</span> </span><span class="WHIT">			</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">nextLine</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">lines.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1792</span> </span><span class="WHIT">				</span><span class="NAME">nextLine</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lines</span><span class="PUNC">[</span><span class="PUNC">++</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1793</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1794</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nextType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nextLine</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">nextLine</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1795</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nextType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1796</span> </span><span class="WHIT">				</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1797</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1798</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1799</span> </span><span class="WHIT">				</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1800</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1801</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1802</span> </span><span class="WHIT">				
<span class="line">1803</span> 		</span><span class="COMM">// see if we&#39;re switching to a new type; if so, package up what we have so far</span><span class="WHIT">
<span class="line">1804</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1805</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curType</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1806</span> </span><span class="WHIT">				</span><span class="NAME">results.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="NAME">curType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">block</span><span class="PUNC">:</span><span class="NAME">curBlock</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1807</span> </span><span class="WHIT">				</span><span class="NAME">unknownBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">curBlock</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">unknownBlock</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1808</span> </span><span class="WHIT">				</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1809</span> </span><span class="WHIT">				</span><span class="NAME">curBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1810</span> </span><span class="WHIT">				</span><span class="NAME">curType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1811</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1812</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1813</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1814</span> </span><span class="WHIT">			</span><span class="NAME">curType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1815</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1816</span> </span><span class="WHIT">		
<span class="line">1817</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isMerged</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_WEAK</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1818</span> </span><span class="WHIT">			</span><span class="NAME">curBlock.push</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1819</span> </span><span class="WHIT">			</span><span class="NAME">curBlock.push</span><span class="PUNC">(</span><span class="NAME">nextLine</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1820</span> </span><span class="WHIT">			</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1821</span> </span><span class="WHIT">			</span><span class="NAME">isMerged</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1822</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1823</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1824</span> </span><span class="WHIT">			</span><span class="NAME">curBlock.push</span><span class="PUNC">(</span><span class="NAME">line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1825</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1826</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1827</span> 
<span class="line">1828</span> </span><span class="WHIT">	</span><span class="COMM">// Handle remaining content</span><span class="WHIT">
<span class="line">1829</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curBlock.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1830</span> </span><span class="WHIT">		</span><span class="NAME">results.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">type</span><span class="PUNC">:</span><span class="NAME">curType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">block</span><span class="PUNC">:</span><span class="NAME">curBlock</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1831</span> </span><span class="WHIT">		</span><span class="NAME">unknownBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">curType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">curBlock</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">unknownBlock</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1832</span> </span><span class="WHIT">		</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">curType</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1833</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1834</span> </span><span class="WHIT">	
<span class="line">1835</span> 	</span><span class="COMM">// Now it&#39;s time to analyze all these blocks that we&#39;ve classified</span><span class="WHIT">
<span class="line">1836</span> 
<span class="line">1837</span> </span><span class="WHIT">	</span><span class="COMM">// Check for UNKNOWN followed by HEADER</span><span class="WHIT">
<span class="line">1838</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">first</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">second</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1839</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">first</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">first.type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">second</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">second.type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">second.type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1840</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getTextFromBlock</span><span class="PUNC">(</span><span class="NAME">first.block</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1841</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1842</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1843</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1844</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1845</span> 
<span class="line">1846</span> </span><span class="WHIT">	</span><span class="COMM">// check for special case of WROTE preceded by UNKNOWN, followed by mix of UNKNOWN and QUOTED (inline reply)</span><span class="WHIT">
<span class="line">1847</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._checkInlineWrote</span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1848</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1849</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1850</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1851</span> 
<span class="line">1852</span> </span><span class="WHIT">	</span><span class="COMM">// If we found quoted content and there&#39;s exactly one UNKNOWN block, return it.</span><span class="WHIT">
<span class="line">1853</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1854</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getTextFromBlock</span><span class="PUNC">(</span><span class="NAME">unknownBlock</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1855</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1856</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1857</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1858</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1859</span> 
<span class="line">1860</span> </span><span class="WHIT">	</span><span class="COMM">// If we have a STRONG separator (eg &#34;--- Original Message ---&#34;), consider it authoritative and return the text that precedes it</span><span class="WHIT">
<span class="line">1861</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1862</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">block</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1863</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">results.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1864</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1865</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result.type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1866</span> </span><span class="WHIT">				</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1867</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1868</span> </span><span class="WHIT">			</span><span class="NAME">block</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">block.concat</span><span class="PUNC">(</span><span class="NAME">result.block</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1869</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1870</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getTextFromBlock</span><span class="PUNC">(</span><span class="NAME">block</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1871</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1872</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1873</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1874</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1875</span> 
<span class="line">1876</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1877</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1878</span> 
<span class="line">1879</span> </span><span class="COMM">// Matches a line of text against some regexes to see if has structural meaning within a mail msg.</span><span class="WHIT">
<span class="line">1880</span> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1881</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1882</span> 
<span class="line">1883</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1884</span> </span><span class="WHIT">	
<span class="line">1885</span> 	</span><span class="COMM">// see if the line matches any known delimiters or quote patterns</span><span class="WHIT">
<span class="line">1886</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.MSG_REGEXES.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1887</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">msgTest</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.MSG_REGEXES</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1888</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">regex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">msgTest.regex</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1889</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">regex.test</span><span class="PUNC">(</span><span class="NAME">testLine.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1890</span> </span><span class="WHIT">			</span><span class="COMM">// line that starts and ends with | is considered ASCII art (eg a table) rather than quoted</span><span class="WHIT">
<span class="line">1891</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">msgTest.type</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="REGX">/^\s*\|.*\|\s*$/</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1892</span> </span><span class="WHIT">				</span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1893</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1894</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">msgTest.type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1895</span> </span><span class="WHIT">			</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="COMM">// first match wins</span><span class="WHIT">
<span class="line">1896</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1897</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1898</span> </span><span class="WHIT">	
<span class="line">1899</span> 	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1900</span> </span><span class="WHIT">		</span><span class="COMM">// &#34;so-and-so wrote:&#34; takes a lot of different forms; look for various common parts and</span><span class="WHIT">
<span class="line">1901</span> </span><span class="WHIT">		</span><span class="COMM">// assign points to determine confidence</span><span class="WHIT">
<span class="line">1902</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">testLine.match</span><span class="PUNC">(</span><span class="REGX">/(\w+):$/</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1903</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">verb</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1904</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">verb</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1905</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1906</span> </span><span class="WHIT">			</span><span class="COMM">// look for &#34;wrote:&#34; (and discount &#34;changed:&#34;, which is used by Bugzilla)</span><span class="WHIT">
<span class="line">1907</span> </span><span class="WHIT">			</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">verb</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxMsg.wrote</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">verb</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxMsg.changed</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1908</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.ORIG_EMAIL_RE.test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1909</span> </span><span class="WHIT">				</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1910</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1911</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.ORIG_DATE_RE.test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1912</span> </span><span class="WHIT">				</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1913</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1914</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">regEx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;^(--|&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">AjxMsg.on</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;)&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;i&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1915</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.ORIG_INTRO_RE.test</span><span class="PUNC">(</span><span class="NAME">testLine</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1916</span> </span><span class="WHIT">				</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1917</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1918</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NUMB">7</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1919</span> </span><span class="WHIT">				</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1920</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1921</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">points</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NUMB">5</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1922</span> </span><span class="WHIT">				</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_WEAK</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1923</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1924</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1925</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1926</span> </span><span class="WHIT">	
<span class="line">1927</span> 	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1928</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1929</span> 
<span class="line">1930</span> </span><span class="NAME">AjxStringUtil._getTextFromBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">1931</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">block</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1932</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">block</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">block.length</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1933</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">block.join</span><span class="PUNC">(</span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1934</span> </span><span class="WHIT">	</span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">originalText.replace</span><span class="PUNC">(</span><span class="REGX">/\s+$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;\n&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1935</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1936</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1937</span> 
<span class="line">1938</span> </span><span class="NAME">AjxStringUtil.SCRIPT_REGEX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1939</span> 
<span class="line">1940</span> </span><span class="COMM">// nodes to ignore; they won&#39;t have anything we&#39;re interested in</span><span class="WHIT">
<span class="line">1941</span> </span><span class="NAME">AjxStringUtil.IGNORE_NODE_LIST</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">&#34;#comment&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;br&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;script&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;select&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;style&#34;</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1942</span> </span><span class="NAME">AjxStringUtil.IGNORE_NODE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxUtil.arrayAsHash</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.IGNORE_NODE_LIST</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1943</span> 
<span class="line">1944</span> </span><span class="COMM">/**
<span class="line">1945</span>  * For HTML, we strip off the html, head, and body tags and stick the rest in a temporary DOM node so that
<span class="line">1946</span>  * we can go element by element. If we find one that is recognized as a separator, we remove all subsequent elements.
<span class="line">1947</span>  *
<span class="line">1948</span>  * @param {string}	text		message body content
<span class="line">1949</span>  *
<span class="line">1950</span>  * @return	{string}	original content if quoted content was found, otherwise NULL
<span class="line">1951</span>  * @private
<span class="line">1952</span>  */</span><span class="WHIT">
<span class="line">1953</span> </span><span class="NAME">AjxStringUtil._getOriginalHtmlContent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1954</span> 
<span class="line">1955</span> </span><span class="WHIT">	</span><span class="COMM">// strip &lt;script&gt; tags (which should not be there)</span><span class="WHIT">
<span class="line">1956</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.SCRIPT_REGEX.test</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1957</span> </span><span class="WHIT">		</span><span class="NAME">text</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">text.replace</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.SCRIPT_REGEX</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1958</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1959</span> 
<span class="line">1960</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">htmlNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._writeToTestIframeDoc</span><span class="PUNC">(</span><span class="NAME">text</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1961</span> 
<span class="line">1962</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">done</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1963</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._flatten</span><span class="PUNC">(</span><span class="NAME">htmlNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeList</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1964</span> 
<span class="line">1965</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ln</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nodeList.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">count</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">prevEl</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">prevType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sepNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1966</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">ln</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1967</span> </span><span class="WHIT">		</span><span class="NAME">el</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nodeList</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1968</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.nodeType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxUtil.ELEMENT_NODE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1969</span> </span><span class="WHIT">			</span><span class="NAME">el.normalize</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1970</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1971</span> </span><span class="WHIT">		</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1972</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._checkNode</span><span class="PUNC">(</span><span class="NAME">nodeList</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1973</span> 
<span class="line">1974</span> </span><span class="WHIT">		</span><span class="COMM">// Check for a multi-element &#34;wrote:&#34; attribution (usually a combo of #text and A nodes), for example:</span><span class="WHIT">
<span class="line">1975</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class="line">1976</span> </span><span class="WHIT">		</span><span class="COMM">//     On Feb 28, 2014, at 3:42 PM, Joe Smith &lt;&lt;a href=&#34;mailto:jsmith@zimbra.com&#34; target=&#34;_blank&#34;&gt;jsmith@zimbra.com&lt;/a&gt;&gt; wrote:</span><span class="WHIT">
<span class="line">1977</span> 
<span class="line">1978</span> </span><span class="WHIT">		</span><span class="COMM">// If the current node is a #text with a date or &#34;On ...&#34;, find #text nodes within the next ten nodes, concatenate them, and check the result.</span><span class="WHIT">
<span class="line">1979</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;#text&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT">
<span class="line">1980</span> </span><span class="WHIT">			</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.ORIG_DATE_RE.test</span><span class="PUNC">(</span><span class="NAME">el.nodeValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_INTRO_RE.test</span><span class="PUNC">(</span><span class="NAME">el.nodeValue</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1981</span> 
<span class="line">1982</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeValue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1983</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1984</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">el1</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nodeList</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1985</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el1.nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;#text&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1986</span> </span><span class="WHIT">					</span><span class="NAME">str</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el1.nodeValue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1987</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="REGX">/:$/</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1988</span> </span><span class="WHIT">						</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1989</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1990</span> </span><span class="WHIT">							</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1991</span> </span><span class="WHIT">							</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">1992</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1993</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1994</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1995</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1996</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">1997</span> 
<span class="line">1998</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">1999</span> </span><span class="WHIT">			</span><span class="NAME">results.push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2000</span> </span><span class="WHIT">			</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">type</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">type</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">type</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2001</span> </span><span class="WHIT">			</span><span class="COMM">// definite separator</span><span class="WHIT">
<span class="line">2002</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2003</span> </span><span class="WHIT">				</span><span class="NAME">sepNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2004</span> </span><span class="WHIT">				</span><span class="NAME">done</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2005</span> </span><span class="WHIT">				</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2006</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2007</span> </span><span class="WHIT">			</span><span class="COMM">// some sort of line followed by a header</span><span class="WHIT">
<span class="line">2008</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_HEADER</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">prevType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_LINE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2009</span> </span><span class="WHIT">				</span><span class="NAME">sepNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">prevEl</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2010</span> </span><span class="WHIT">				</span><span class="NAME">done</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2011</span> </span><span class="WHIT">				</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2012</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2013</span> </span><span class="WHIT">			</span><span class="NAME">prevEl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2014</span> </span><span class="WHIT">			</span><span class="NAME">prevType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2015</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2016</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2017</span> 
<span class="line">2018</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">sepNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2019</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._prune</span><span class="PUNC">(</span><span class="NAME">sepNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2020</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2021</span> 
<span class="line">2022</span> </span><span class="WHIT">	</span><span class="COMM">// convert back to text, restoring html, head, and body nodes</span><span class="WHIT">
<span class="line">2023</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">done</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;html&gt;&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">htmlNode.innerHTML</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;/html&gt;&#34;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">text</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2024</span> 
<span class="line">2025</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._removeTestIframeDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2026</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2027</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2028</span> 
<span class="line">2029</span> </span><span class="COMM">/**
<span class="line">2030</span>  * Traverse the given node depth-first to produce a list of descendant nodes. Some nodes are
<span class="line">2031</span>  * ignored.
<span class="line">2032</span>  *
<span class="line">2033</span>  * @param {Element}     node        node
<span class="line">2034</span>  * @param {Array}       list        result list which grows in place
<span class="line">2035</span>  * @private
<span class="line">2036</span>  */</span><span class="WHIT">
<span class="line">2037</span> </span><span class="NAME">AjxStringUtil._flatten</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">list</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2038</span> 
<span class="line">2039</span> </span><span class="WHIT">	</span><span class="NAME">list.push</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2040</span> 
<span class="line">2041</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.childNodes</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2042</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">children.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2043</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">el</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">2044</span> </span><span class="WHIT">			</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2045</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#39;blockquote&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">AjxStringUtil.IGNORE_NODE</span><span class="PUNC">[</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2046</span> </span><span class="WHIT">			</span><span class="NAME">this._flatten</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">list</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2047</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2048</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2049</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2050</span> 
<span class="line">2051</span> </span><span class="COMM">/**
<span class="line">2052</span>  * Removes all subsequent siblings of the given node, and then does the same for its parent.
<span class="line">2053</span>  * The effect is that all nodes that come after the given node in a depth-first traversal of
<span class="line">2054</span>  * the DOM will be removed.
<span class="line">2055</span>  *
<span class="line">2056</span>  * @param {Element}     node
<span class="line">2057</span>  * @param {Boolean}     clipNode    if true, also remove the node
<span class="line">2058</span>  * @private
<span class="line">2059</span>  */</span><span class="WHIT">
<span class="line">2060</span> </span><span class="NAME">AjxStringUtil._prune</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">clipNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2061</span> 
<span class="line">2062</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">node.parentNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2063</span> </span><span class="WHIT">	</span><span class="COMM">// clip all subsequent nodes</span><span class="WHIT">
<span class="line">2064</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">p.lastChild</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">p.lastChild</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2065</span> </span><span class="WHIT">		</span><span class="NAME">p.removeChild</span><span class="PUNC">(</span><span class="NAME">p.lastChild</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2066</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2067</span> </span><span class="WHIT">	</span><span class="COMM">// clip the node if asked</span><span class="WHIT">
<span class="line">2068</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">clipNode</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">p.lastChild</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2069</span> </span><span class="WHIT">		</span><span class="NAME">p.removeChild</span><span class="PUNC">(</span><span class="NAME">p.lastChild</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2070</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2071</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">p.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2072</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#39;body&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#39;html&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2073</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._prune</span><span class="PUNC">(</span><span class="NAME">p</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2074</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2075</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2076</span> 
<span class="line">2077</span> </span><span class="COMM">/**
<span class="line">2078</span>  * Tries to determine the type of the given node.
<span class="line">2079</span>  *
<span class="line">2080</span>  * @param {Element}     el      a DOM node
<span class="line">2081</span>  * @return {String}     type, or null
<span class="line">2082</span>  * @private
<span class="line">2083</span>  */</span><span class="WHIT">
<span class="line">2084</span> </span><span class="NAME">AjxStringUtil._checkNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2085</span> 
<span class="line">2086</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">el</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2087</span> 
<span class="line">2088</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2089</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2090</span> 
<span class="line">2091</span> </span><span class="WHIT">	</span><span class="COMM">// Text node: test against our regexes</span><span class="WHIT">
<span class="line">2092</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;#text&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2093</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">content</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">el.nodeValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2094</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">content</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2095</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">content</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2096</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2097</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2098</span> </span><span class="WHIT">	</span><span class="COMM">// HR: look for a couple different forms that are used to delimit quoted content</span><span class="WHIT">
<span class="line">2099</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;hr&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2100</span> </span><span class="WHIT">		</span><span class="COMM">// see if the HR is ours, or one commonly used by other mail clients such as Outlook</span><span class="WHIT">
<span class="line">2101</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.id</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.HTML_SEP_ID</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.size</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;2&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.width</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;100%&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.align</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;center&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2102</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2103</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2104</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2105</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_LINE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2106</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2107</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2108</span> </span><span class="WHIT">	</span><span class="COMM">// PRE: treat as one big line of text (should maybe go line by line)</span><span class="WHIT">
<span class="line">2109</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;pre&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2110</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._checkNodeContent</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2111</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2112</span> </span><span class="WHIT">	</span><span class="COMM">// DIV: check for Outlook class used as delimiter, or a top border used as a separator, and finally just</span><span class="WHIT">
<span class="line">2113</span> </span><span class="WHIT">	</span><span class="COMM">// check the text content</span><span class="WHIT">
<span class="line">2114</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;div&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2115</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.className</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;OutlookMessageHeader&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">el.className</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;gmail_quote&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2116</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2117</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2118</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.style.borderTop</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2119</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">styleObj</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">DwtCssStyle.getComputedStyleObject</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2120</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">styleObj</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">styleObj.borderTopWidth</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">styleObj.borderTopWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">styleObj.borderTopColor</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2121</span> </span><span class="WHIT">				</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2122</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2123</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2124</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._checkNodeContent</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2125</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2126</span> </span><span class="WHIT">	</span><span class="COMM">// SPAN: check text content</span><span class="WHIT">
<span class="line">2127</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;span&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2128</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._checkNodeContent</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2129</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2130</span> </span><span class="WHIT">	</span><span class="COMM">// IMG: treat as original content</span><span class="WHIT">
<span class="line">2131</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;img&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2132</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2133</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2134</span> </span><span class="WHIT">	</span><span class="COMM">// BLOCKQUOTE: treat as quoted section</span><span class="WHIT">
<span class="line">2135</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;blockquote&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2136</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2137</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2138</span> 
<span class="line">2139</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2140</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2141</span> 
<span class="line">2142</span> </span><span class="COMM">/**
<span class="line">2143</span>  * Checks innerText to see if it&#39;s a separator.
<span class="line">2144</span>  * @param {Element} node
<span class="line">2145</span>  * @return {String}
<span class="line">2146</span>  * @private
<span class="line">2147</span>  */</span><span class="WHIT">
<span class="line">2148</span> </span><span class="NAME">AjxStringUtil._checkNodeContent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2149</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">content</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.innerText</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2150</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil._NON_WHITESPACE.test</span><span class="PUNC">(</span><span class="NAME">content</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">content.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">200</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2151</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2152</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2153</span> </span><span class="WHIT">	</span><span class="COMM">// We&#39;re really only interested in SEP_STRONG and WROTE_STRONG</span><span class="WHIT">
<span class="line">2154</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getLineType</span><span class="PUNC">(</span><span class="NAME">content</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2155</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_SEP_STRONG</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2156</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2157</span> 
<span class="line">2158</span> </span><span class="COMM">/**
<span class="line">2159</span>  * Checks the given HTML to see if it is &#34;safe&#34;, and cleans it up if it is. It must have only
<span class="line">2160</span>  * the tags in the given list, otherwise false is returned. Attributes in the given list will
<span class="line">2161</span>  * be removed. It is not necessary to include &#34;#text&#34;, &#34;html&#34;, &#34;head&#34;, and &#34;body&#34; in the list
<span class="line">2162</span>  * of allowed tags.
<span class="line">2163</span>  * 
<span class="line">2164</span>  * @param {string}	html			HTML text
<span class="line">2165</span>  * @param {array}	okTags			whitelist of allowed tags
<span class="line">2166</span>  * @param {array}	untrustedAttrs	list of attributes to not allow in non-iframe.
<span class="line">2167</span>  */</span><span class="WHIT">
<span class="line">2168</span> </span><span class="NAME">AjxStringUtil.checkForCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">2169</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">okTags</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">untrustedAttrs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2170</span> 
<span class="line">2171</span> </span><span class="WHIT">    </span><span class="COMM">//Bug: 83708 - strip hashed anchor links from email msg</span><span class="WHIT">
<span class="line">2172</span> </span><span class="WHIT">    </span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="STRN">&#34;href\s*=\s*([&#39;\&#34;])\s*#((?!\\1).)*\\1&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;g&#34;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2173</span> 
<span class="line">2174</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">htmlNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._writeToTestIframeDoc</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2175</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2176</span> </span><span class="WHIT">		</span><span class="NAME">allowedTags</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">AjxUtil.arrayAsHash</span><span class="PUNC">(</span><span class="NAME">okTags</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">2177</span> </span><span class="WHIT">		</span><span class="NAME">untrustedAttrs</span><span class="PUNC">:</span><span class="WHIT">	</span><span class="NAME">untrustedAttrs</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT">
<span class="line">2178</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2179</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._traverseCleanHtml</span><span class="PUNC">(</span><span class="NAME">htmlNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2180</span> 
<span class="line">2181</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;html&gt;&#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">htmlNode.innerHTML</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#34;&lt;/html&gt;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2182</span> 
<span class="line">2183</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">width</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.max</span><span class="PUNC">(</span><span class="NAME">htmlNode.scrollWidth</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">htmlNode.lastChild.scrollWidth</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2184</span> 
<span class="line">2185</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._removeTestIframeDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2186</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">html</span><span class="PUNC">:</span><span class="NAME">result</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">width</span><span class="PUNC">:</span><span class="NAME">width</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">useIframe</span><span class="PUNC">:</span><span class="NAME">ctxt.fail</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2187</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2188</span> 
<span class="line">2189</span> </span><span class="NAME">AjxStringUtil._traverseCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">2190</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">el</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2191</span> 
<span class="line">2192</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2193</span> 
<span class="line">2194</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2195</span> </span><span class="WHIT">	
<span class="line">2196</span> 	</span><span class="COMM">// useless &lt;style&gt; that we used to add, remove it</span><span class="WHIT">
<span class="line">2197</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;style&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.innerHTML</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;p { margin: 0; }&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2198</span> </span><span class="WHIT">		</span><span class="NAME">el.doDelete</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2199</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2200</span> </span><span class="WHIT">	
<span class="line">2201</span> 	</span><span class="COMM">// IE likes to insert an empty &lt;title&gt; in the &lt;head&gt;, let it go</span><span class="WHIT">
<span class="line">2202</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;title&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">el.innerHTML</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2203</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2204</span> </span><span class="WHIT">	
<span class="line">2205</span> 	</span><span class="COMM">// see if tag is allowed</span><span class="WHIT">
<span class="line">2206</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ctxt.allowedTags</span><span class="PUNC">[</span><span class="NAME">nodeName</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2207</span> 
<span class="line">2208</span> </span><span class="WHIT">        </span><span class="COMM">//checks for invalid styles and removes them.  Bug: 78875 - bad styles from user = email displays incorrectly</span><span class="WHIT">
<span class="line">2209</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.style</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2210</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">style</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.style</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.style.cssText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2211</span> </span><span class="WHIT">            </span><span class="NAME">style</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">style.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2212</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">AjxStringUtil._checkStyle</span><span class="PUNC">(</span><span class="NAME">style</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2213</span> </span><span class="WHIT">                </span><span class="NAME">isCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2214</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2215</span> </span><span class="WHIT">            </span><span class="NAME">el.style.cssText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._fixStyle</span><span class="PUNC">(</span><span class="NAME">style</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2216</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2217</span> 
<span class="line">2218</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.removeAttribute</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.attributes</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">el.attributes.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2219</span> </span><span class="WHIT">			</span><span class="COMM">// check for blacklisted attrs</span><span class="WHIT">
<span class="line">2220</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">ctxt.untrustedAttrs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2221</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">el.hasAttribute</span><span class="PUNC">(</span><span class="NAME">ctxt.untrustedAttrs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2222</span> </span><span class="WHIT">					</span><span class="NAME">isCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2223</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2224</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2225</span> </span><span class="WHIT">			
<span class="line">2226</span> 			</span><span class="COMM">// Note that DOM-based handling of attributes is horribly broken in IE, in all sorts of ways.</span><span class="WHIT">
<span class="line">2227</span> </span><span class="WHIT">			</span><span class="COMM">// In IE it is impossible to find a reliable way to get an attribute&#39;s value. The attributes</span><span class="WHIT">
<span class="line">2228</span> </span><span class="WHIT">			</span><span class="COMM">// collection is supposed to be attributes that were specified in the HTML, but IE fills it with every</span><span class="WHIT">
<span class="line">2229</span> </span><span class="WHIT">			</span><span class="COMM">// possible attribute.</span><span class="WHIT">
<span class="line">2230</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attrs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.attributes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">l</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attrs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">l</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2231</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">attr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attrs.item</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2232</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">attrName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attr.nodeName</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">attr.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2233</span> </span><span class="WHIT">				</span><span class="COMM">// on* handlers (should have been removed by server, check again to be safe)</span><span class="WHIT">
<span class="line">2234</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">attrName</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">attrName.indexOf</span><span class="PUNC">(</span><span class="STRN">&#34;on&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2235</span> </span><span class="WHIT">					</span><span class="NAME">el.removeAttribute</span><span class="PUNC">(</span><span class="NAME">attrName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2236</span> </span><span class="WHIT">					</span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2237</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2238</span> </span><span class="WHIT">				</span><span class="COMM">// this might not work in IE</span><span class="WHIT">
<span class="line">2239</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">attrValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attr.nodeValue</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">String</span><span class="PUNC">(</span><span class="NAME">attr.nodeValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2240</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">attrValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2241</span> </span><span class="WHIT">					</span><span class="NAME">attrValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attrValue.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2242</span> </span><span class="WHIT">					</span><span class="COMM">// we have global CSS rules for TD that trump table properties, so bail</span><span class="WHIT">
<span class="line">2243</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;table&#34;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">attrName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;cellpadding&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">attrName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;cellspacing&#34;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">2244</span> </span><span class="WHIT">							</span><span class="NAME">attrName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;border&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">attrValue</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;0&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2245</span> </span><span class="WHIT">						</span><span class="NAME">isCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2246</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2247</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2248</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2249</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2250</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2251</span> </span><span class="WHIT">	
<span class="line">2252</span> 	</span><span class="COMM">// disallowed tag - bail</span><span class="WHIT">
<span class="line">2253</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2254</span> </span><span class="WHIT">        </span><span class="NAME">isCleanHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2255</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2256</span> </span><span class="WHIT">	
<span class="line">2257</span> 	</span><span class="COMM">// process child nodes</span><span class="WHIT">
<span class="line">2258</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2259</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2260</span> </span><span class="WHIT">		</span><span class="NAME">AjxStringUtil._traverseCleanHtml</span><span class="PUNC">(</span><span class="NAME">childNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ctxt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2261</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2262</span> </span><span class="WHIT">	
<span class="line">2263</span> 	</span><span class="COMM">// remove nodes marked for deletion</span><span class="WHIT">
<span class="line">2264</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.childNodes.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">--</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2265</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">el.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2266</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">childNode.doDelete</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2267</span> </span><span class="WHIT">			</span><span class="NAME">el.removeChild</span><span class="PUNC">(</span><span class="NAME">childNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2268</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2269</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2270</span> 
<span class="line">2271</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isCleanHtml</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2272</span> </span><span class="WHIT">        </span><span class="NAME">ctxt.fail</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2273</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2274</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2275</span> 
<span class="line">2276</span> 
<span class="line">2277</span> </span><span class="NAME">AjxStringUtil._checkStyle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">2278</span> </span><span class="WHIT">    </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">style</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2279</span> 
<span class="line">2280</span> </span><span class="WHIT">        </span><span class="COMM">//check for absolute positioning</span><span class="WHIT">
<span class="line">2281</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">style.match</span><span class="PUNC">(</span><span class="REGX">/\bposition\s*:\s*absolute[^;]*;?/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2282</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2283</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2284</span> 
<span class="line">2285</span> </span><span class="WHIT">        </span><span class="COMM">//check for font-&lt;anything&gt;</span><span class="WHIT">
<span class="line">2286</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">style.match</span><span class="PUNC">(</span><span class="REGX">/\bfont-[^;]*;?/</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2287</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2288</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2289</span> 
<span class="line">2290</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2291</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2292</span> 
<span class="line">2293</span> </span><span class="NAME">AjxStringUtil._fixStyle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">2294</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">style</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2295</span> 
<span class="line">2296</span> </span><span class="WHIT">    </span><span class="COMM">//check for negative margins</span><span class="WHIT">
<span class="line">2297</span> </span><span class="WHIT">    </span><span class="NAME">style</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">style.replace</span><span class="PUNC">(</span><span class="REGX">/\bmargin-?(top|left|right|bottom)?\s*:[^;]*-\d+[^;]*;?/gi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2298</span> 
<span class="line">2299</span> </span><span class="WHIT">    </span><span class="COMM">//check for negative padding</span><span class="WHIT">
<span class="line">2300</span> </span><span class="WHIT">    </span><span class="NAME">style</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">style.replace</span><span class="PUNC">(</span><span class="REGX">/\bpadding-?(top|left|right|bottom)?\s*:[^;]*-\d+[^;]*;?/gi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2301</span> 
<span class="line">2302</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">style</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2303</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2304</span> 
<span class="line">2305</span> </span><span class="COMM">/**
<span class="line">2306</span>  * A &#34;... wrote:&#34; separator is not quite as authoritative, since the user might be replying inline. If we have
<span class="line">2307</span>  * a single UNKNOWN block before the WROTE separator, return it unless there is a mix of QUOTED and UNKNOWN
<span class="line">2308</span>  * following the separator, except if there&#39;s only a single unknown block after the separator and it comes last.
<span class="line">2309</span>  * 
<span class="line">2310</span>  * @private
<span class="line">2311</span>  */</span><span class="WHIT">
<span class="line">2312</span> </span><span class="NAME">AjxStringUtil._checkInlineWrote</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class="line">2313</span> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2314</span> 
<span class="line">2315</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2316</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">unknownBlock</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">foundSep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">afterSep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2317</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">results.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2318</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.type</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2319</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_WROTE_STRONG</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2320</span> </span><span class="WHIT">				</span><span class="NAME">foundSep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2321</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2322</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">foundSep</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2323</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">unknownBlock</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2324</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2325</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2326</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2327</span> </span><span class="WHIT">					</span><span class="NAME">unknownBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.block</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2328</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2329</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2330</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">foundSep</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2331</span> </span><span class="WHIT">				</span><span class="NAME">afterSep</span><span class="PUNC">[</span><span class="NAME">type</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2332</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2333</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2334</span> 
<span class="line">2335</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mixed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">afterSep</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">afterSep</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_QUOTED</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2336</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">endsWithUnknown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">count</span><span class="PUNC">[</span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">results</span><span class="PUNC">[</span><span class="NAME">results.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.ORIG_UNKNOWN</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2337</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">unknownBlock</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">mixed</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">endsWithUnknown</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2338</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._getTextFromBlock</span><span class="PUNC">(</span><span class="NAME">unknownBlock</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2339</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originalText</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2340</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">originalText</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2341</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2342</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2343</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2344</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2345</span> 
<span class="line">2346</span> </span><span class="COMM">/**
<span class="line">2347</span>  * Removes non-content HTML from the beginning and end. The idea is to remove anything that would
<span class="line">2348</span>  * appear to the user as blank space. This function is an approximation since that&#39;s hard to do,
<span class="line">2349</span>  * especially when dealing with HTML as a string.
<span class="line">2350</span>  *
<span class="line">2351</span>  * @param {String}  html    HTML to fix
<span class="line">2352</span>  * @return {String} trimmed HTML
<span class="line">2353</span>  * @adapts AjxStringUtil.trimHtml
<span class="line">2354</span>  */</span><span class="WHIT">
<span class="line">2355</span> </span><span class="NAME">AjxStringUtil.trimHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2356</span> 
<span class="line">2357</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2358</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2359</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2360</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2361</span> 
<span class="line">2362</span> </span><span class="WHIT">	</span><span class="COMM">// remove doc-level tags if they don&#39;t have attributes</span><span class="WHIT">
<span class="line">2363</span> </span><span class="WHIT">	</span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.replace</span><span class="PUNC">(</span><span class="NAME">AjxStringUtil.DOC_TAG_REGEX</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2364</span> 
<span class="line">2365</span> </span><span class="WHIT">	</span><span class="COMM">// some editors like to put every &lt;br&gt; in a &lt;div&gt;</span><span class="WHIT">
<span class="line">2366</span> </span><span class="WHIT">	</span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.replace</span><span class="PUNC">(</span><span class="REGX">/&lt;div&gt;&lt;br ?\/?&gt;&lt;\/div&gt;/gi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;br&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2367</span> 
<span class="line">2368</span> </span><span class="WHIT">	</span><span class="COMM">// remove leading/trailing &lt;br&gt;</span><span class="WHIT">
<span class="line">2369</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2370</span> </span><span class="WHIT">	</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">trimmedHtml.length</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="REGX">/^&lt;br ?\/?&gt;/i</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">trimmedHtml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="REGX">/&lt;br ?\/?&gt;$/i</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">trimmedHtml</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2371</span> </span><span class="WHIT">		</span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.length</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="COMM">// loop prevention</span><span class="WHIT">
<span class="line">2372</span> </span><span class="WHIT">		</span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.replace</span><span class="PUNC">(</span><span class="REGX">/^&lt;br ?\/?&gt;/i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/&lt;br ?\/?&gt;$/i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2373</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2374</span> 
<span class="line">2375</span> </span><span class="WHIT">	</span><span class="COMM">// remove trailing &lt;br&gt; trapped in front of closing tags</span><span class="WHIT">
<span class="line">2376</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.match</span><span class="PUNC">(</span><span class="REGX">/((&lt;br ?\/?&gt;)+)((&lt;\/\w+&gt;)+)$/i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2377</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">m</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">m.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2378</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">regex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RegExp</span><span class="PUNC">(</span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">&#39;$&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;i&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2379</span> </span><span class="WHIT">		</span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.replace</span><span class="PUNC">(</span><span class="NAME">regex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">m</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2380</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2381</span> 
<span class="line">2382</span> </span><span class="WHIT">	</span><span class="COMM">// remove empty internal &lt;div&gt; containers</span><span class="WHIT">
<span class="line">2383</span> </span><span class="WHIT">	</span><span class="NAME">trimmedHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedHtml.replace</span><span class="PUNC">(</span><span class="REGX">/(&lt;div&gt;&lt;\/div&gt;)+/gi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2384</span> 
<span class="line">2385</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil.trim</span><span class="PUNC">(</span><span class="NAME">trimmedHtml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2386</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2387</span> 
<span class="line">2388</span> </span><span class="COMM">// regex for removing empty doc tags from an HTML string</span><span class="WHIT">
<span class="line">2389</span> </span><span class="NAME">AjxStringUtil.DOC_TAG_REGEX</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/&lt;\/?(html|head|body)&gt;/gi</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2390</span> 
<span class="line">2391</span> </span><span class="COMM">// Convert the html to DOM nodes, update the img src with the defanged field value,</span><span class="WHIT">
<span class="line">2392</span> </span><span class="COMM">// and then return the html inside the body.</span><span class="WHIT">
<span class="line">2393</span> </span><span class="COMM">// TODO: See about using a DocumentFragment</span><span class="WHIT">
<span class="line">2394</span> </span><span class="NAME">AjxStringUtil.defangHtmlContent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2395</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">htmlNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">AjxStringUtil._writeToTestIframeDoc</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2396</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">images</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">htmlNode.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">&#34;img&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2397</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">images</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">images.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2398</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">imgEl</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2399</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dfSrcContent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2400</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">images.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2401</span> </span><span class="WHIT">			</span><span class="NAME">imgEl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">images</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2402</span> </span><span class="WHIT">			</span><span class="NAME">dfSrcContent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imgEl.getAttribute</span><span class="PUNC">(</span><span class="STRN">&#34;dfsrc&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2403</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dfSrcContent</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dfSrcContent</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">&#34;#&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2404</span> </span><span class="WHIT">				</span><span class="NAME">imgEl.setAttribute</span><span class="PUNC">(</span><span class="STRN">&#34;src&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dfSrcContent</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2405</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2406</span> </span><span class="WHIT">			</span><span class="NAME">imgEl.removeAttribute</span><span class="PUNC">(</span><span class="STRN">&#34;dfsrc&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2407</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2408</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2409</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">content</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#34;&#34;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2410</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">htmlNode.childNodes</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2411</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">children.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2412</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">children</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">tagName</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">children</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">tagName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#34;body&#34;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">2413</span> </span><span class="WHIT">			</span><span class="NAME">content</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">innerHTML</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2414</span> </span><span class="WHIT">			</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2415</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2416</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">2417</span> </span><span class="WHIT">	</span><span class="NAME">AjxStringUtil._removeTestIframeDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2418</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">content</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2419</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">2420</span> 
<span class="line">2421</span> </span></pre></body></html>
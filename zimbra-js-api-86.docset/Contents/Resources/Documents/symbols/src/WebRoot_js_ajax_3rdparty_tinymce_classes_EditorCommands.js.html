<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class="line">  1</span> <span class="COMM">/**
<span class="line">  2</span>  * EditorCommands.js
<span class="line">  3</span>  *
<span class="line">  4</span>  * Copyright, Moxiecode Systems AB
<span class="line">  5</span>  * Released under LGPL License.
<span class="line">  6</span>  *
<span class="line">  7</span>  * License: http://www.tinymce.com/license
<span class="line">  8</span>  * Contributing: http://www.tinymce.com/contributing
<span class="line">  9</span>  */</span><span class="WHIT">
<span class="line"> 10</span> 
<span class="line"> 11</span> </span><span class="COMM">/**
<span class="line"> 12</span>  * This class enables you to add custom editor commands and it contains
<span class="line"> 13</span>  * overrides for native browser commands to address various bugs and issues.
<span class="line"> 14</span>  *
<span class="line"> 15</span>  * @class tinymce.EditorCommands
<span class="line"> 16</span>  */</span><span class="WHIT">
<span class="line"> 17</span> </span><span class="NAME">define</span><span class="PUNC">(</span><span class="STRN">&#34;tinymce/EditorCommands&#34;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class="line"> 18</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/html/Serializer&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 19</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/Env&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 20</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/util/Tools&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 21</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/dom/ElementUtils&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 22</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/dom/RangeUtils&#34;</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 23</span> </span><span class="WHIT">	</span><span class="STRN">&#34;tinymce/dom/TreeWalker&#34;</span><span class="WHIT">
<span class="line"> 24</span> </span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">Serializer</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Env</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Tools</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ElementUtils</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">RangeUtils</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">TreeWalker</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 25</span> </span><span class="WHIT">	</span><span class="COMM">// Added for compression purposes</span><span class="WHIT">
<span class="line"> 26</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">each</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Tools.each</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">extend</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Tools.extend</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 27</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">map</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Tools.map</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Tools.inArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">explode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Tools.explode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 28</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isGecko</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Env.gecko</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isIE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Env.ie</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isOldIE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Env.ie</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">Env.ie</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">11</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 29</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">FALSE</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 30</span> 
<span class="line"> 31</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">editor</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 32</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dom</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.dom</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 33</span> </span><span class="WHIT">			</span><span class="NAME">selection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.selection</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 34</span> </span><span class="WHIT">			</span><span class="NAME">commands</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">state</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">exec</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 35</span> </span><span class="WHIT">			</span><span class="NAME">settings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.settings</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 36</span> </span><span class="WHIT">			</span><span class="NAME">formatter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.formatter</span><span class="PUNC">,</span><span class="WHIT">
<span class="line"> 37</span> </span><span class="WHIT">			</span><span class="NAME">bookmark</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 38</span> 
<span class="line"> 39</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class="line"> 40</span> 		 * Executes the specified command.
<span class="line"> 41</span> 		 *
<span class="line"> 42</span> 		 * @method execCommand
<span class="line"> 43</span> 		 * @param {String} command Command to execute.
<span class="line"> 44</span> 		 * @param {Boolean} ui Optional user interface state.
<span class="line"> 45</span> 		 * @param {Object} value Optional value for command.
<span class="line"> 46</span> 		 * @return {Boolean} true/false if the command was found or not.
<span class="line"> 47</span> 		 */</span><span class="WHIT">
<span class="line"> 48</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">execCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 49</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 50</span> 
<span class="line"> 51</span> </span><span class="WHIT">			</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">command.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 52</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">commands.exec</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 53</span> </span><span class="WHIT">				</span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 54</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 55</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 56</span> 
<span class="line"> 57</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">FALSE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 58</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 59</span> 
<span class="line"> 60</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class="line"> 61</span> 		 * Queries the current state for a command for example if the current selection is &#34;bold&#34;.
<span class="line"> 62</span> 		 *
<span class="line"> 63</span> 		 * @method queryCommandState
<span class="line"> 64</span> 		 * @param {String} command Command to check the state of.
<span class="line"> 65</span> 		 * @return {Boolean/Number} true/false if the selected contents is bold or not, -1 if it&#39;s not found.
<span class="line"> 66</span> 		 */</span><span class="WHIT">
<span class="line"> 67</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">queryCommandState</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 68</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 69</span> 
<span class="line"> 70</span> </span><span class="WHIT">			</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">command.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 71</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">commands.state</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 72</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 73</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 74</span> 
<span class="line"> 75</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 76</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 77</span> 
<span class="line"> 78</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class="line"> 79</span> 		 * Queries the command value for example the current fontsize.
<span class="line"> 80</span> 		 *
<span class="line"> 81</span> 		 * @method queryCommandValue
<span class="line"> 82</span> 		 * @param {String} command Command to check the value of.
<span class="line"> 83</span> 		 * @return {Object} Command value of false if it&#39;s not found.
<span class="line"> 84</span> 		 */</span><span class="WHIT">
<span class="line"> 85</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">queryCommandValue</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 86</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 87</span> 
<span class="line"> 88</span> </span><span class="WHIT">			</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">command.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 89</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">commands.value</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line"> 90</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 91</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 92</span> 
<span class="line"> 93</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">FALSE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line"> 94</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line"> 95</span> 
<span class="line"> 96</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class="line"> 97</span> 		 * Adds commands to the command collection.
<span class="line"> 98</span> 		 *
<span class="line"> 99</span> 		 * @method addCommands
<span class="line">100</span> 		 * @param {Object} command_list Name/value collection with commands to add, the names can also be comma separated.
<span class="line">101</span> 		 * @param {String} type Optional type to add, defaults to exec. Can be value or state as well.
<span class="line">102</span> 		 */</span><span class="WHIT">
<span class="line">103</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">addCommands</span><span class="PUNC">(</span><span class="NAME">command_list</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">type</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">104</span> </span><span class="WHIT">			</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#39;exec&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">105</span> 
<span class="line">106</span> </span><span class="WHIT">			</span><span class="NAME">each</span><span class="PUNC">(</span><span class="NAME">command_list</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">107</span> </span><span class="WHIT">				</span><span class="NAME">each</span><span class="PUNC">(</span><span class="NAME">command.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#39;,&#39;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">108</span> </span><span class="WHIT">					</span><span class="NAME">commands</span><span class="PUNC">[</span><span class="NAME">type</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">command</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">109</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">110</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">111</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">112</span> 
<span class="line">113</span> </span><span class="WHIT">		</span><span class="COMM">// Expose public methods</span><span class="WHIT">
<span class="line">114</span> </span><span class="WHIT">		</span><span class="NAME">extend</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">115</span> </span><span class="WHIT">			</span><span class="NAME">execCommand</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">execCommand</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">116</span> </span><span class="WHIT">			</span><span class="NAME">queryCommandState</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">queryCommandState</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">117</span> </span><span class="WHIT">			</span><span class="NAME">queryCommandValue</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">queryCommandValue</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">118</span> </span><span class="WHIT">			</span><span class="NAME">addCommands</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">addCommands</span><span class="WHIT">
<span class="line">119</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">120</span> 
<span class="line">121</span> </span><span class="WHIT">		</span><span class="COMM">// Private methods</span><span class="WHIT">
<span class="line">122</span> 
<span class="line">123</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">execNativeCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">124</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ui</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">125</span> </span><span class="WHIT">				</span><span class="NAME">ui</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">FALSE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">126</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">127</span> 
<span class="line">128</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">129</span> </span><span class="WHIT">				</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">130</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">131</span> 
<span class="line">132</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">editor.getDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">execCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">133</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">134</span> 
<span class="line">135</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">isFormatMatch</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">136</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">formatter.match</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">137</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">138</span> 
<span class="line">139</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">140</span> </span><span class="WHIT">			</span><span class="NAME">formatter.toggle</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">value</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">141</span> </span><span class="WHIT">			</span><span class="NAME">editor.nodeChanged</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">142</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">143</span> 
<span class="line">144</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">storeSelection</span><span class="PUNC">(</span><span class="NAME">type</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">145</span> </span><span class="WHIT">			</span><span class="NAME">bookmark</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getBookmark</span><span class="PUNC">(</span><span class="NAME">type</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">146</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">147</span> 
<span class="line">148</span> </span><span class="WHIT">		</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">restoreSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">149</span> </span><span class="WHIT">			</span><span class="NAME">selection.moveToBookmark</span><span class="PUNC">(</span><span class="NAME">bookmark</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">150</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">151</span> 
<span class="line">152</span> </span><span class="WHIT">		</span><span class="COMM">// Add execCommand overrides</span><span class="WHIT">
<span class="line">153</span> </span><span class="WHIT">		</span><span class="NAME">addCommands</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">154</span> </span><span class="WHIT">			</span><span class="COMM">// Ignore these, added for compatibility</span><span class="WHIT">
<span class="line">155</span> </span><span class="WHIT">			</span><span class="STRN">&#39;mceResetDesignMode,mceBeginUndoLevel&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">156</span> 
<span class="line">157</span> </span><span class="WHIT">			</span><span class="COMM">// Add undo manager logic</span><span class="WHIT">
<span class="line">158</span> </span><span class="WHIT">			</span><span class="STRN">&#39;mceEndUndoLevel,mceAddUndoLevel&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">159</span> </span><span class="WHIT">				</span><span class="NAME">editor.undoManager.add</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">160</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">161</span> 
<span class="line">162</span> </span><span class="WHIT">			</span><span class="STRN">&#39;Cut,Copy,Paste&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">163</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">failed</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">164</span> 
<span class="line">165</span> </span><span class="WHIT">				</span><span class="COMM">// Try executing the native command</span><span class="WHIT">
<span class="line">166</span> </span><span class="WHIT">				</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">167</span> </span><span class="WHIT">					</span><span class="NAME">execNativeCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">168</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">169</span> </span><span class="WHIT">					</span><span class="COMM">// Command failed</span><span class="WHIT">
<span class="line">170</span> </span><span class="WHIT">					</span><span class="NAME">failed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">171</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">172</span> 
<span class="line">173</span> </span><span class="WHIT">				</span><span class="COMM">// Present alert message about clipboard access not being available</span><span class="WHIT">
<span class="line">174</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">failed</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">doc.queryCommandSupported</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">175</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">msg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.translate</span><span class="PUNC">(</span><span class="WHIT">
<span class="line">176</span> </span><span class="WHIT">						</span><span class="STRN">&#34;Your browser doesn&#39;t support direct access to the clipboard. &#34;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class="line">177</span> </span><span class="WHIT">						</span><span class="STRN">&#34;Please use the Ctrl+X/C/V keyboard shortcuts instead.&#34;</span><span class="WHIT">
<span class="line">178</span> </span><span class="WHIT">					</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">179</span> 
<span class="line">180</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Env.mac</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">181</span> </span><span class="WHIT">						</span><span class="NAME">msg</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">msg.replace</span><span class="PUNC">(</span><span class="REGX">/Ctrl\+/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;\u2318+&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">182</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">183</span> 
<span class="line">184</span> </span><span class="WHIT">					</span><span class="NAME">editor.windowManager.alert</span><span class="PUNC">(</span><span class="NAME">msg</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">185</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">186</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">187</span> 
<span class="line">188</span> </span><span class="WHIT">			</span><span class="COMM">// Override unlink command</span><span class="WHIT">
<span class="line">189</span> </span><span class="WHIT">			</span><span class="NAME">unlink</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">190</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">selection.isCollapsed</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">191</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">elm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">192</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">elm.tagName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;A&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">193</span> </span><span class="WHIT">						</span><span class="NAME">editor.dom.remove</span><span class="PUNC">(</span><span class="NAME">elm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">194</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">195</span> 
<span class="line">196</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">197</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">198</span> 
<span class="line">199</span> </span><span class="WHIT">				</span><span class="NAME">formatter.remove</span><span class="PUNC">(</span><span class="STRN">&#34;link&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">200</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">201</span> 
<span class="line">202</span> </span><span class="WHIT">			</span><span class="COMM">// Override justify commands to use the text formatter engine</span><span class="WHIT">
<span class="line">203</span> </span><span class="WHIT">			</span><span class="STRN">&#39;JustifyLeft,JustifyCenter,JustifyRight,JustifyFull&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">204</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">align</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">command.substring</span><span class="PUNC">(</span><span class="NUMB">7</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">205</span> 
<span class="line">206</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">align</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;full&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">207</span> </span><span class="WHIT">					</span><span class="NAME">align</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;justify&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">208</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">209</span> 
<span class="line">210</span> </span><span class="WHIT">				</span><span class="COMM">// Remove all other alignments first</span><span class="WHIT">
<span class="line">211</span> </span><span class="WHIT">				</span><span class="NAME">each</span><span class="PUNC">(</span><span class="STRN">&#39;left,center,right,justify&#39;</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">&#39;,&#39;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">212</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">align</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">213</span> </span><span class="WHIT">						</span><span class="NAME">formatter.remove</span><span class="PUNC">(</span><span class="STRN">&#39;align&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">214</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">215</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">216</span> 
<span class="line">217</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="STRN">&#39;align&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">align</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">218</span> </span><span class="WHIT">				</span><span class="NAME">execCommand</span><span class="PUNC">(</span><span class="STRN">&#39;mceRepaint&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">219</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">220</span> 
<span class="line">221</span> </span><span class="WHIT">			</span><span class="COMM">// Override list commands to fix WebKit bug</span><span class="WHIT">
<span class="line">222</span> </span><span class="WHIT">			</span><span class="STRN">&#39;InsertUnorderedList,InsertOrderedList&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">223</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listElm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listParent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">224</span> 
<span class="line">225</span> </span><span class="WHIT">				</span><span class="NAME">execNativeCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">226</span> 
<span class="line">227</span> </span><span class="WHIT">				</span><span class="COMM">// WebKit produces lists within block elements so we need to split them</span><span class="WHIT">
<span class="line">228</span> </span><span class="WHIT">				</span><span class="COMM">// we will replace the native list creation logic to custom logic later on</span><span class="WHIT">
<span class="line">229</span> </span><span class="WHIT">				</span><span class="COMM">// TODO: Remove this when the list creation logic is removed</span><span class="WHIT">
<span class="line">230</span> </span><span class="WHIT">				</span><span class="NAME">listElm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;ol,ul&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">231</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">listElm</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">232</span> </span><span class="WHIT">					</span><span class="NAME">listParent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">listElm.parentNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">233</span> 
<span class="line">234</span> </span><span class="WHIT">					</span><span class="COMM">// If list is within a text block then split that block</span><span class="WHIT">
<span class="line">235</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="REGX">/^(H[1-6]|P|ADDRESS|PRE)$/</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">listParent.nodeName</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">236</span> </span><span class="WHIT">						</span><span class="NAME">storeSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">237</span> </span><span class="WHIT">						</span><span class="NAME">dom.split</span><span class="PUNC">(</span><span class="NAME">listParent</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">238</span> </span><span class="WHIT">						</span><span class="NAME">restoreSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">239</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">240</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">241</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">242</span> 
<span class="line">243</span> </span><span class="WHIT">			</span><span class="COMM">// Override commands to use the text formatter engine</span><span class="WHIT">
<span class="line">244</span> </span><span class="WHIT">			</span><span class="STRN">&#39;Bold,Italic,Underline,Strikethrough,Superscript,Subscript&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">245</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">246</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">247</span> 
<span class="line">248</span> </span><span class="WHIT">			</span><span class="COMM">// Override commands to use the text formatter engine</span><span class="WHIT">
<span class="line">249</span> </span><span class="WHIT">			</span><span class="STRN">&#39;ForeColor,HiliteColor,FontName&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">250</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">251</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">252</span> 
<span class="line">253</span> </span><span class="WHIT">			</span><span class="NAME">FontSize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">254</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fontClasses</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fontSizes</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">255</span> 
<span class="line">256</span> </span><span class="WHIT">				</span><span class="COMM">// Convert font size 1-7 to styles</span><span class="WHIT">
<span class="line">257</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NUMB">7</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">258</span> </span><span class="WHIT">					</span><span class="NAME">fontSizes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">explode</span><span class="PUNC">(</span><span class="NAME">settings.font_size_style_values</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">259</span> </span><span class="WHIT">					</span><span class="NAME">fontClasses</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">explode</span><span class="PUNC">(</span><span class="NAME">settings.font_size_classes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">260</span> 
<span class="line">261</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fontClasses</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">262</span> </span><span class="WHIT">						</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fontClasses</span><span class="PUNC">[</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">263</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">264</span> </span><span class="WHIT">						</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fontSizes</span><span class="PUNC">[</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">265</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">266</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">267</span> 
<span class="line">268</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">269</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">270</span> 
<span class="line">271</span> </span><span class="WHIT">			</span><span class="NAME">RemoveFormat</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">272</span> </span><span class="WHIT">				</span><span class="NAME">formatter.remove</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">273</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">274</span> 
<span class="line">275</span> </span><span class="WHIT">			</span><span class="NAME">mceBlockQuote</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">276</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="STRN">&#39;blockquote&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">277</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">278</span> 
<span class="line">279</span> </span><span class="WHIT">			</span><span class="NAME">FormatBlock</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">280</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">&#39;p&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">281</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">282</span> 
<span class="line">283</span> </span><span class="WHIT">			</span><span class="NAME">mceCleanup</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">284</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bookmark</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getBookmark</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">285</span> 
<span class="line">286</span> </span><span class="WHIT">				</span><span class="NAME">editor.setContent</span><span class="PUNC">(</span><span class="NAME">editor.getContent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">cleanup</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">cleanup</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">287</span> 
<span class="line">288</span> </span><span class="WHIT">				</span><span class="NAME">selection.moveToBookmark</span><span class="PUNC">(</span><span class="NAME">bookmark</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">289</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">290</span> 
<span class="line">291</span> </span><span class="WHIT">			</span><span class="NAME">mceRemoveNode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">292</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">293</span> 
<span class="line">294</span> </span><span class="WHIT">				</span><span class="COMM">// Make sure that the body node isn&#39;t removed</span><span class="WHIT">
<span class="line">295</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">296</span> </span><span class="WHIT">					</span><span class="NAME">storeSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">297</span> </span><span class="WHIT">					</span><span class="NAME">editor.dom.remove</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">298</span> </span><span class="WHIT">					</span><span class="NAME">restoreSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">299</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">300</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">301</span> 
<span class="line">302</span> </span><span class="WHIT">			</span><span class="NAME">mceSelectNodeDepth</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">303</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">304</span> 
<span class="line">305</span> </span><span class="WHIT">				</span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">306</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">307</span> </span><span class="WHIT">						</span><span class="NAME">selection.select</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">308</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">FALSE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">309</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">310</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">311</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">312</span> 
<span class="line">313</span> </span><span class="WHIT">			</span><span class="NAME">mceSelectNode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">314</span> </span><span class="WHIT">				</span><span class="NAME">selection.select</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">315</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">316</span> 
<span class="line">317</span> </span><span class="WHIT">			</span><span class="NAME">mceInsertContent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">318</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parser</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">serializer</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parentNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fragment</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">319</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">marker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rng</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node2</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">bookmarkHtml</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">merge</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">320</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">textInlineElements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.schema.getTextInlineElements</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">321</span> 
<span class="line">322</span> </span><span class="WHIT">				</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">trimOrPaddLeftRight</span><span class="PUNC">(</span><span class="NAME">html</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">323</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rng</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">container</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">offset</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">324</span> 
<span class="line">325</span> </span><span class="WHIT">					</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getRng</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">326</span> </span><span class="WHIT">					</span><span class="NAME">container</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rng.startContainer</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">327</span> </span><span class="WHIT">					</span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rng.startOffset</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">328</span> 
<span class="line">329</span> </span><span class="WHIT">					</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">hasSiblingText</span><span class="PUNC">(</span><span class="NAME">siblingName</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">330</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">container</span><span class="PUNC">[</span><span class="NAME">siblingName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">container</span><span class="PUNC">[</span><span class="NAME">siblingName</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">331</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">332</span> 
<span class="line">333</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">container.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">334</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">335</span> </span><span class="WHIT">							</span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="REGX">/^&nbsp;/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39; &#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">336</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">hasSiblingText</span><span class="PUNC">(</span><span class="STRN">&#39;previousSibling&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">337</span> </span><span class="WHIT">							</span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="REGX">/^ /</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">338</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">339</span> 
<span class="line">340</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">container.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">341</span> </span><span class="WHIT">							</span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="REGX">/&nbsp;(&lt;br&gt;|)$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39; &#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">342</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">hasSiblingText</span><span class="PUNC">(</span><span class="STRN">&#39;nextSibling&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">343</span> </span><span class="WHIT">							</span><span class="NAME">html</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">html.replace</span><span class="PUNC">(</span><span class="REGX">/(&nbsp;| )(&lt;br&gt;|)$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">344</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">345</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">346</span> 
<span class="line">347</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">html</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">348</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">349</span> 
<span class="line">350</span> </span><span class="WHIT">				</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">markInlineFormatElements</span><span class="PUNC">(</span><span class="NAME">fragment</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">351</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">merge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">352</span> </span><span class="WHIT">						</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fragment.firstChild</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.walk</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">353</span> </span><span class="WHIT">							</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">textInlineElements</span><span class="PUNC">[</span><span class="NAME">node.name</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">354</span> </span><span class="WHIT">								</span><span class="NAME">node.attr</span><span class="PUNC">(</span><span class="STRN">&#39;data-mce-new&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#34;true&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">355</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">356</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">357</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">358</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">359</span> 
<span class="line">360</span> </span><span class="WHIT">				</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">reduceInlineTextElements</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">361</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">merge</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">362</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">elementUtils</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">ElementUtils</span><span class="PUNC">(</span><span class="NAME">dom</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">363</span> 
<span class="line">364</span> </span><span class="WHIT">						</span><span class="NAME">each</span><span class="PUNC">(</span><span class="NAME">dom.select</span><span class="PUNC">(</span><span class="STRN">&#39;*[data-mce-new]&#39;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">365</span> </span><span class="WHIT">							</span><span class="NAME">node.removeAttribute</span><span class="PUNC">(</span><span class="STRN">&#39;data-mce-new&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">366</span> 
<span class="line">367</span> </span><span class="WHIT">							</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">testNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.parentNode</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">testNode</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">testNode</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">root</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">testNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">testNode.parentNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">368</span> </span><span class="WHIT">								</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">elementUtils.compare</span><span class="PUNC">(</span><span class="NAME">testNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">369</span> </span><span class="WHIT">									</span><span class="NAME">dom.remove</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">370</span> </span><span class="WHIT">								</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">371</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">372</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">373</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">374</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">375</span> 
<span class="line">376</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#39;string&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">377</span> </span><span class="WHIT">					</span><span class="NAME">merge</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.merge</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">378</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.content</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">379</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">380</span> 
<span class="line">381</span> </span><span class="WHIT">				</span><span class="COMM">// Check for whitespace before/after value</span><span class="WHIT">
<span class="line">382</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="REGX">/^ | $/</span><span class="PUNC">.</span><span class="NAME">test</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">383</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimOrPaddLeftRight</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">384</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">385</span> 
<span class="line">386</span> </span><span class="WHIT">				</span><span class="COMM">// Setup parser and serializer</span><span class="WHIT">
<span class="line">387</span> </span><span class="WHIT">				</span><span class="NAME">parser</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.parser</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">388</span> </span><span class="WHIT">				</span><span class="NAME">serializer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Serializer</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">editor.schema</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">389</span> </span><span class="WHIT">				</span><span class="NAME">bookmarkHtml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;span id=&#34;mce_marker&#34; data-mce-type=&#34;bookmark&#34;&gt;&lt;/span&gt;&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">390</span> 
<span class="line">391</span> </span><span class="WHIT">				</span><span class="COMM">// Run beforeSetContent handlers on the HTML to be inserted</span><span class="WHIT">
<span class="line">392</span> </span><span class="WHIT">				</span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">content</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">format</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;html&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">selection</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">393</span> </span><span class="WHIT">				</span><span class="NAME">editor.fire</span><span class="PUNC">(</span><span class="STRN">&#39;BeforeSetContent&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">394</span> </span><span class="WHIT">				</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">args.content</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">395</span> 
<span class="line">396</span> </span><span class="WHIT">				</span><span class="COMM">// Add caret at end of contents if it&#39;s missing</span><span class="WHIT">
<span class="line">397</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value.indexOf</span><span class="PUNC">(</span><span class="STRN">&#39;{$caret}&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">398</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;{$caret}&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">399</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">400</span> 
<span class="line">401</span> </span><span class="WHIT">				</span><span class="COMM">// Replace the caret marker with a span bookmark element</span><span class="WHIT">
<span class="line">402</span> </span><span class="WHIT">				</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.replace</span><span class="PUNC">(</span><span class="REGX">/\{\$caret\}/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">bookmarkHtml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">403</span> 
<span class="line">404</span> </span><span class="WHIT">				</span><span class="COMM">// If selection is at &lt;body&gt;|&lt;p&gt;&lt;/p&gt; then move it into &lt;body&gt;&lt;p&gt;|&lt;/p&gt;</span><span class="WHIT">
<span class="line">405</span> </span><span class="WHIT">				</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">406</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">caretElement</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rng.startContainer</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">rng.parentElement</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">rng.parentElement</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">407</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">body</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">408</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">caretElement</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">body</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">selection.isCollapsed</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">409</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dom.isBlock</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">dom.isEmpty</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">410</span> </span><span class="WHIT">						</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.createRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">411</span> </span><span class="WHIT">						</span><span class="NAME">rng.setStart</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">412</span> </span><span class="WHIT">						</span><span class="NAME">rng.setEnd</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">413</span> </span><span class="WHIT">						</span><span class="NAME">selection.setRng</span><span class="PUNC">(</span><span class="NAME">rng</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">414</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">415</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">416</span> 
<span class="line">417</span> </span><span class="WHIT">				</span><span class="COMM">// Insert node maker where we will insert the new HTML and get it&#39;s parent</span><span class="WHIT">
<span class="line">418</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">selection.isCollapsed</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">419</span> </span><span class="WHIT">					</span><span class="NAME">editor.getDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">execCommand</span><span class="PUNC">(</span><span class="STRN">&#39;Delete&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">420</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">421</span> 
<span class="line">422</span> </span><span class="WHIT">				</span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">423</span> 
<span class="line">424</span> </span><span class="WHIT">				</span><span class="COMM">// Parse the fragment within the context of the parent node</span><span class="WHIT">
<span class="line">425</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parserArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">context</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">parentNode.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">426</span> </span><span class="WHIT">				</span><span class="NAME">fragment</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parser.parse</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parserArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">427</span> 
<span class="line">428</span> </span><span class="WHIT">				</span><span class="NAME">markInlineFormatElements</span><span class="PUNC">(</span><span class="NAME">fragment</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">429</span> 
<span class="line">430</span> </span><span class="WHIT">				</span><span class="COMM">// Move the caret to a more suitable location</span><span class="WHIT">
<span class="line">431</span> </span><span class="WHIT">				</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fragment.lastChild</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">432</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node.attr</span><span class="PUNC">(</span><span class="STRN">&#39;id&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;mce_marker&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">433</span> </span><span class="WHIT">					</span><span class="NAME">marker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">434</span> 
<span class="line">435</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.prev</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.walk</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">436</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node.type</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">dom.isBlock</span><span class="PUNC">(</span><span class="NAME">node.name</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">437</span> </span><span class="WHIT">							</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editor.schema.isValidChild</span><span class="PUNC">(</span><span class="NAME">node.parent.name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;span&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">438</span> </span><span class="WHIT">								</span><span class="NAME">node.parent.insert</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node.name</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;br&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">439</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">440</span> </span><span class="WHIT">							</span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">441</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">442</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">443</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">444</span> 
<span class="line">445</span> </span><span class="WHIT">				</span><span class="COMM">// If parser says valid we can insert the contents into that parent</span><span class="WHIT">
<span class="line">446</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">parserArgs.invalid</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">447</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serializer.serialize</span><span class="PUNC">(</span><span class="NAME">fragment</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">448</span> 
<span class="line">449</span> </span><span class="WHIT">					</span><span class="COMM">// Check if parent is empty or only has one BR element then set the innerHTML of that parent</span><span class="WHIT">
<span class="line">450</span> </span><span class="WHIT">					</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentNode.firstChild</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">451</span> </span><span class="WHIT">					</span><span class="NAME">node2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentNode.lastChild</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">452</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">node2</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">node.nodeName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;BR&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">453</span> </span><span class="WHIT">						</span><span class="NAME">dom.setHTML</span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">454</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">455</span> </span><span class="WHIT">						</span><span class="NAME">selection.setContent</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">456</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">457</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">458</span> </span><span class="WHIT">					</span><span class="COMM">// If the fragment was invalid within that context then we need</span><span class="WHIT">
<span class="line">459</span> </span><span class="WHIT">					</span><span class="COMM">// to parse and process the parent it&#39;s inserted into</span><span class="WHIT">
<span class="line">460</span> 
<span class="line">461</span> </span><span class="WHIT">					</span><span class="COMM">// Insert bookmark node and get the parent</span><span class="WHIT">
<span class="line">462</span> </span><span class="WHIT">					</span><span class="NAME">selection.setContent</span><span class="PUNC">(</span><span class="NAME">bookmarkHtml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">463</span> </span><span class="WHIT">					</span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">464</span> </span><span class="WHIT">					</span><span class="NAME">rootNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">465</span> 
<span class="line">466</span> </span><span class="WHIT">					</span><span class="COMM">// Opera will return the document node when selection is in root</span><span class="WHIT">
<span class="line">467</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parentNode.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">9</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">468</span> </span><span class="WHIT">						</span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">469</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">470</span> </span><span class="WHIT">						</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">471</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">472</span> 
<span class="line">473</span> </span><span class="WHIT">					</span><span class="COMM">// Find the ancestor just before the root element</span><span class="WHIT">
<span class="line">474</span> </span><span class="WHIT">					</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">475</span> </span><span class="WHIT">						</span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">476</span> </span><span class="WHIT">						</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.parentNode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">477</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">478</span> 
<span class="line">479</span> </span><span class="WHIT">					</span><span class="COMM">// Get the outer/inner HTML depending on if we are in the root and parser and serialize that</span><span class="WHIT">
<span class="line">480</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">rootNode.innerHTML</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">dom.getOuterHTML</span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">481</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">serializer.serialize</span><span class="PUNC">(</span><span class="WHIT">
<span class="line">482</span> </span><span class="WHIT">						</span><span class="NAME">parser.parse</span><span class="PUNC">(</span><span class="WHIT">
<span class="line">483</span> </span><span class="WHIT">							</span><span class="COMM">// Need to replace by using a function since $ in the contents would otherwise be a problem</span><span class="WHIT">
<span class="line">484</span> </span><span class="WHIT">							</span><span class="NAME">value.replace</span><span class="PUNC">(</span><span class="REGX">/&lt;span (id=&#34;mce_marker&#34;|id=mce_marker).+?&lt;\/span&gt;/i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">485</span> </span><span class="WHIT">								</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">serializer.serialize</span><span class="PUNC">(</span><span class="NAME">fragment</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">486</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">487</span> </span><span class="WHIT">						</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">488</span> </span><span class="WHIT">					</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">489</span> 
<span class="line">490</span> </span><span class="WHIT">					</span><span class="COMM">// Set the inner/outer HTML depending on if we are in the root or not</span><span class="WHIT">
<span class="line">491</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">492</span> </span><span class="WHIT">						</span><span class="NAME">dom.setHTML</span><span class="PUNC">(</span><span class="NAME">rootNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">493</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">494</span> </span><span class="WHIT">						</span><span class="NAME">dom.setOuterHTML</span><span class="PUNC">(</span><span class="NAME">parentNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">495</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">496</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">497</span> 
<span class="line">498</span> </span><span class="WHIT">				</span><span class="NAME">reduceInlineTextElements</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">499</span> 
<span class="line">500</span> </span><span class="WHIT">				</span><span class="NAME">marker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.get</span><span class="PUNC">(</span><span class="STRN">&#39;mce_marker&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">501</span> </span><span class="WHIT">				</span><span class="NAME">selection.scrollIntoView</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">502</span> 
<span class="line">503</span> </span><span class="WHIT">				</span><span class="COMM">// Move selection before marker and remove it</span><span class="WHIT">
<span class="line">504</span> </span><span class="WHIT">				</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.createRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">505</span> 
<span class="line">506</span> </span><span class="WHIT">				</span><span class="COMM">// If previous sibling is a text node set the selection to the end of that node</span><span class="WHIT">
<span class="line">507</span> </span><span class="WHIT">				</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">marker.previousSibling</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">508</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">node.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">509</span> </span><span class="WHIT">					</span><span class="NAME">rng.setStart</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node.nodeValue.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">510</span> 
<span class="line">511</span> </span><span class="WHIT">					</span><span class="COMM">// TODO: Why can&#39;t we normalize on IE</span><span class="WHIT">
<span class="line">512</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isIE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">513</span> </span><span class="WHIT">						</span><span class="NAME">node2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">marker.nextSibling</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">514</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node2</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">node2.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">515</span> </span><span class="WHIT">							</span><span class="NAME">node.appendData</span><span class="PUNC">(</span><span class="NAME">node2.data</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">516</span> </span><span class="WHIT">							</span><span class="NAME">node2.parentNode.removeChild</span><span class="PUNC">(</span><span class="NAME">node2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">517</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">518</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">519</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">520</span> </span><span class="WHIT">					</span><span class="COMM">// If the previous sibling isn&#39;t a text node or doesn&#39;t exist set the selection before the marker node</span><span class="WHIT">
<span class="line">521</span> </span><span class="WHIT">					</span><span class="NAME">rng.setStartBefore</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">522</span> </span><span class="WHIT">					</span><span class="NAME">rng.setEndBefore</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">523</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">524</span> 
<span class="line">525</span> </span><span class="WHIT">				</span><span class="COMM">// Remove the marker node and set the new range</span><span class="WHIT">
<span class="line">526</span> </span><span class="WHIT">				</span><span class="NAME">dom.remove</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">527</span> </span><span class="WHIT">				</span><span class="NAME">selection.setRng</span><span class="PUNC">(</span><span class="NAME">rng</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">528</span> 
<span class="line">529</span> </span><span class="WHIT">				</span><span class="COMM">// Dispatch after event and add any visual elements needed</span><span class="WHIT">
<span class="line">530</span> </span><span class="WHIT">				</span><span class="NAME">editor.fire</span><span class="PUNC">(</span><span class="STRN">&#39;SetContent&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">531</span> </span><span class="WHIT">				</span><span class="NAME">editor.addVisual</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">532</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">533</span> 
<span class="line">534</span> </span><span class="WHIT">			</span><span class="NAME">mceInsertRawHTML</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">535</span> </span><span class="WHIT">				</span><span class="NAME">selection.setContent</span><span class="PUNC">(</span><span class="STRN">&#39;tiny_mce_marker&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">536</span> </span><span class="WHIT">				</span><span class="NAME">editor.setContent</span><span class="PUNC">(</span><span class="WHIT">
<span class="line">537</span> </span><span class="WHIT">					</span><span class="NAME">editor.getContent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/tiny_mce_marker/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">538</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">539</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">540</span> </span><span class="WHIT">				</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">541</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">542</span> 
<span class="line">543</span> </span><span class="WHIT">			</span><span class="NAME">mceToggleFormat</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">544</span> </span><span class="WHIT">				</span><span class="NAME">toggleFormat</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">545</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">546</span> 
<span class="line">547</span> </span><span class="WHIT">			</span><span class="NAME">mceSetContent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">548</span> </span><span class="WHIT">				</span><span class="NAME">editor.setContent</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">549</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">550</span> 
<span class="line">551</span> </span><span class="WHIT">			</span><span class="STRN">&#39;Indent,Outdent&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">552</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">intentValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentUnit</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">553</span> 
<span class="line">554</span> </span><span class="WHIT">				</span><span class="COMM">// Setup indent level</span><span class="WHIT">
<span class="line">555</span> </span><span class="WHIT">				</span><span class="NAME">intentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">settings.indentation</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">556</span> </span><span class="WHIT">				</span><span class="NAME">indentUnit</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/[a-z%]+$/i</span><span class="PUNC">.</span><span class="NAME">exec</span><span class="PUNC">(</span><span class="NAME">intentValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">557</span> </span><span class="WHIT">				</span><span class="NAME">intentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">intentValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">558</span> 
<span class="line">559</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">queryCommandState</span><span class="PUNC">(</span><span class="STRN">&#39;InsertUnorderedList&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">queryCommandState</span><span class="PUNC">(</span><span class="STRN">&#39;InsertOrderedList&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">560</span> </span><span class="WHIT">					</span><span class="COMM">// If forced_root_blocks is set to false we don&#39;t have a block to indent so lets create a div</span><span class="WHIT">
<span class="line">561</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">settings.forced_root_block</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">562</span> </span><span class="WHIT">						</span><span class="NAME">formatter.apply</span><span class="PUNC">(</span><span class="STRN">&#39;div&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">563</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">564</span> 
<span class="line">565</span> </span><span class="WHIT">					</span><span class="NAME">each</span><span class="PUNC">(</span><span class="NAME">selection.getSelectedBlocks</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">element</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">566</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">element.nodeName</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">&#34;LI&#34;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">567</span> </span><span class="WHIT">							</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">indentStyleName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getParam</span><span class="PUNC">(</span><span class="STRN">&#39;indent_use_margin&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#39;margin&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;padding&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">568</span> 
<span class="line">569</span> </span><span class="WHIT">							</span><span class="NAME">indentStyleName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getStyle</span><span class="PUNC">(</span><span class="NAME">element</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;direction&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;rtl&#39;</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">&#39;Right&#39;</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;Left&#39;</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">570</span> 
<span class="line">571</span> </span><span class="WHIT">							</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;outdent&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">572</span> </span><span class="WHIT">								</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.max</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">element.style</span><span class="PUNC">[</span><span class="NAME">indentStyleName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">intentValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">573</span> </span><span class="WHIT">								</span><span class="NAME">dom.setStyle</span><span class="PUNC">(</span><span class="NAME">element</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentStyleName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">indentUnit</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">574</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">575</span> </span><span class="WHIT">								</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">element.style</span><span class="PUNC">[</span><span class="NAME">indentStyleName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">intentValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">indentUnit</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">576</span> </span><span class="WHIT">								</span><span class="NAME">dom.setStyle</span><span class="PUNC">(</span><span class="NAME">element</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">indentStyleName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">577</span> </span><span class="WHIT">							</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">578</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">579</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">580</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">581</span> </span><span class="WHIT">					</span><span class="NAME">execNativeCommand</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">582</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">583</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">584</span> 
<span class="line">585</span> </span><span class="WHIT">			</span><span class="NAME">mceRepaint</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">586</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isGecko</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">587</span> </span><span class="WHIT">					</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">588</span> </span><span class="WHIT">						</span><span class="NAME">storeSelection</span><span class="PUNC">(</span><span class="NAME">TRUE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">589</span> 
<span class="line">590</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">selection.getSel</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">591</span> </span><span class="WHIT">							</span><span class="NAME">selection.getSel</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">selectAllChildren</span><span class="PUNC">(</span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">592</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">593</span> 
<span class="line">594</span> </span><span class="WHIT">						</span><span class="NAME">selection.collapse</span><span class="PUNC">(</span><span class="NAME">TRUE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">595</span> </span><span class="WHIT">						</span><span class="NAME">restoreSelection</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">596</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">597</span> </span><span class="WHIT">						</span><span class="COMM">// Ignore</span><span class="WHIT">
<span class="line">598</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">599</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">600</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">601</span> 
<span class="line">602</span> </span><span class="WHIT">			</span><span class="NAME">InsertHorizontalRule</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">603</span> </span><span class="WHIT">				</span><span class="NAME">editor.execCommand</span><span class="PUNC">(</span><span class="STRN">&#39;mceInsertContent&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&lt;hr /&gt;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">604</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">605</span> 
<span class="line">606</span> </span><span class="WHIT">			</span><span class="NAME">mceToggleVisualAid</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">607</span> </span><span class="WHIT">				</span><span class="NAME">editor.hasVisual</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">editor.hasVisual</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">608</span> </span><span class="WHIT">				</span><span class="NAME">editor.addVisual</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">609</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">610</span> 
<span class="line">611</span> </span><span class="WHIT">			</span><span class="NAME">mceReplaceContent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">612</span> </span><span class="WHIT">				</span><span class="NAME">editor.execCommand</span><span class="PUNC">(</span><span class="STRN">&#39;mceInsertContent&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value.replace</span><span class="PUNC">(</span><span class="REGX">/\{\$selection\}/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">selection.getContent</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">format</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;text&#39;</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">613</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">614</span> 
<span class="line">615</span> </span><span class="WHIT">			</span><span class="NAME">mceInsertLink</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">616</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">anchor</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">617</span> 
<span class="line">618</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;string&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">619</span> </span><span class="WHIT">					</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">href</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">620</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">621</span> 
<span class="line">622</span> </span><span class="WHIT">				</span><span class="NAME">anchor</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;a&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">623</span> 
<span class="line">624</span> </span><span class="WHIT">				</span><span class="COMM">// Spaces are never valid in URLs and it&#39;s a very common mistake for people to make so we fix it here.</span><span class="WHIT">
<span class="line">625</span> </span><span class="WHIT">				</span><span class="NAME">value.href</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.href.replace</span><span class="PUNC">(</span><span class="STRN">&#39; &#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;%20&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">626</span> 
<span class="line">627</span> </span><span class="WHIT">				</span><span class="COMM">// Remove existing links if there could be child links or that the href isn&#39;t specified</span><span class="WHIT">
<span class="line">628</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">anchor</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">value.href</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">629</span> </span><span class="WHIT">					</span><span class="NAME">formatter.remove</span><span class="PUNC">(</span><span class="STRN">&#39;link&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">630</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">631</span> 
<span class="line">632</span> </span><span class="WHIT">				</span><span class="COMM">// Apply new link to selection</span><span class="WHIT">
<span class="line">633</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value.href</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">634</span> </span><span class="WHIT">					</span><span class="NAME">formatter.apply</span><span class="PUNC">(</span><span class="STRN">&#39;link&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">anchor</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">635</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">636</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">637</span> 
<span class="line">638</span> </span><span class="WHIT">			</span><span class="NAME">selectAll</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">639</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getRoot</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rng</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">640</span> 
<span class="line">641</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">selection.getRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">setStart</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">642</span> </span><span class="WHIT">					</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.createRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">643</span> </span><span class="WHIT">					</span><span class="NAME">rng.setStart</span><span class="PUNC">(</span><span class="NAME">root</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">644</span> </span><span class="WHIT">					</span><span class="NAME">rng.setEnd</span><span class="PUNC">(</span><span class="NAME">root</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">root.childNodes.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">645</span> </span><span class="WHIT">					</span><span class="NAME">selection.setRng</span><span class="PUNC">(</span><span class="NAME">rng</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">646</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">647</span> </span><span class="WHIT">					</span><span class="COMM">// IE will render it&#39;s own root level block elements and sometimes</span><span class="WHIT">
<span class="line">648</span> </span><span class="WHIT">					</span><span class="COMM">// even put font elements in them when the user starts typing. So we need to</span><span class="WHIT">
<span class="line">649</span> </span><span class="WHIT">					</span><span class="COMM">// move the selection to a more suitable element from this:</span><span class="WHIT">
<span class="line">650</span> </span><span class="WHIT">					</span><span class="COMM">// &lt;body&gt;|&lt;p&gt;&lt;/p&gt;&lt;/body&gt; to this: &lt;body&gt;&lt;p&gt;|&lt;/p&gt;&lt;/body&gt;</span><span class="WHIT">
<span class="line">651</span> </span><span class="WHIT">					</span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getRng</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">652</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">rng.item</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">653</span> </span><span class="WHIT">						</span><span class="NAME">rng.moveToElementText</span><span class="PUNC">(</span><span class="NAME">root</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">654</span> </span><span class="WHIT">						</span><span class="NAME">rng.select</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">655</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">656</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">657</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">658</span> 
<span class="line">659</span> </span><span class="WHIT">			</span><span class="STRN">&#34;delete&#34;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">660</span> </span><span class="WHIT">				</span><span class="NAME">execNativeCommand</span><span class="PUNC">(</span><span class="STRN">&#34;Delete&#34;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">661</span> 
<span class="line">662</span> </span><span class="WHIT">				</span><span class="COMM">// Check if body is empty after the delete call if so then set the contents</span><span class="WHIT">
<span class="line">663</span> </span><span class="WHIT">				</span><span class="COMM">// to an empty string and move the caret to any block produced by that operation</span><span class="WHIT">
<span class="line">664</span> </span><span class="WHIT">				</span><span class="COMM">// this fixes the issue with root blocks not being properly produced after a delete call on IE</span><span class="WHIT">
<span class="line">665</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">body</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.getBody</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">666</span> 
<span class="line">667</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dom.isEmpty</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">668</span> </span><span class="WHIT">					</span><span class="NAME">editor.setContent</span><span class="PUNC">(</span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">669</span> 
<span class="line">670</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">671</span> </span><span class="WHIT">						</span><span class="NAME">editor.selection.setCursorLocation</span><span class="PUNC">(</span><span class="NAME">body.firstChild</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">672</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">673</span> </span><span class="WHIT">						</span><span class="NAME">editor.selection.setCursorLocation</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">674</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">675</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">676</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">677</span> 
<span class="line">678</span> </span><span class="WHIT">			</span><span class="NAME">mceNewDocument</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">679</span> </span><span class="WHIT">				</span><span class="NAME">editor.setContent</span><span class="PUNC">(</span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">680</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">681</span> 
<span class="line">682</span> </span><span class="WHIT">			</span><span class="NAME">InsertLineBreak</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ui</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">683</span> </span><span class="WHIT">				</span><span class="COMM">// We load the current event in from EnterKey.js when appropriate to heed</span><span class="WHIT">
<span class="line">684</span> </span><span class="WHIT">				</span><span class="COMM">// certain event-specific variations such as ctrl-enter in a list</span><span class="WHIT">
<span class="line">685</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evt</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">686</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">brElm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">extraBr</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">marker</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">687</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rng</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.getRng</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">688</span> </span><span class="WHIT">				</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">RangeUtils</span><span class="PUNC">(</span><span class="NAME">dom</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">normalize</span><span class="PUNC">(</span><span class="NAME">rng</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">689</span> 
<span class="line">690</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rng.startOffset</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">691</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">container</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rng.startContainer</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">692</span> 
<span class="line">693</span> </span><span class="WHIT">				</span><span class="COMM">// Resolve node index</span><span class="WHIT">
<span class="line">694</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">container.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">container.hasChildNodes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">695</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isAfterLastNodeInContainer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NAME">container.childNodes.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">696</span> 
<span class="line">697</span> </span><span class="WHIT">					</span><span class="NAME">container</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">container.childNodes</span><span class="PUNC">[</span><span class="NAME">Math.min</span><span class="PUNC">(</span><span class="NAME">offset</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">container.childNodes.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">container</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">698</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isAfterLastNodeInContainer</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">container.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">699</span> </span><span class="WHIT">						</span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">container.nodeValue.length</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">700</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">701</span> </span><span class="WHIT">						</span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">702</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">703</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">704</span> 
<span class="line">705</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">container</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">706</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentBlockName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentBlock</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">parentBlock.nodeName.toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// IE &lt; 9 &amp; HTML5</span><span class="WHIT">
<span class="line">707</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containerBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentBlock</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">parentBlock.parentNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">708</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">containerBlockName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">containerBlock</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">containerBlock.nodeName.toUpperCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// IE &lt; 9 &amp; HTML5</span><span class="WHIT">
<span class="line">709</span> 
<span class="line">710</span> </span><span class="WHIT">				</span><span class="COMM">// Enter inside block contained within a LI then split or insert before/after LI</span><span class="WHIT">
<span class="line">711</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isControlKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evt</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">evt.ctrlKey</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">712</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">containerBlockName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;LI&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">isControlKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">713</span> </span><span class="WHIT">					</span><span class="NAME">parentBlock</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">containerBlock</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">714</span> </span><span class="WHIT">					</span><span class="NAME">parentBlockName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">containerBlockName</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">715</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">716</span> 
<span class="line">717</span> </span><span class="WHIT">				</span><span class="COMM">// Walks the parent block to the right and look for BR elements</span><span class="WHIT">
<span class="line">718</span> </span><span class="WHIT">				</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">hasRightSideContent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">719</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">walker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">TreeWalker</span><span class="PUNC">(</span><span class="NAME">container</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parentBlock</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">720</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nonEmptyElementsMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editor.schema.getNonEmptyElements</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">721</span> 
<span class="line">722</span> </span><span class="WHIT">					</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">walker.next</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">723</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nonEmptyElementsMap</span><span class="PUNC">[</span><span class="NAME">node.nodeName.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">node.length</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">724</span> </span><span class="WHIT">							</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">725</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">726</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">727</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">728</span> 
<span class="line">729</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">container</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">container.nodeType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">offset</span><span class="WHIT"> </span><span class="PUNC">&gt;=</span><span class="WHIT"> </span><span class="NAME">container.nodeValue.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">730</span> </span><span class="WHIT">					</span><span class="COMM">// Insert extra BR element at the end block elements</span><span class="WHIT">
<span class="line">731</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isOldIE</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">hasRightSideContent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">732</span> </span><span class="WHIT">						</span><span class="NAME">brElm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.create</span><span class="PUNC">(</span><span class="STRN">&#39;br&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">733</span> </span><span class="WHIT">						</span><span class="NAME">rng.insertNode</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">734</span> </span><span class="WHIT">						</span><span class="NAME">rng.setStartAfter</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">735</span> </span><span class="WHIT">						</span><span class="NAME">rng.setEndAfter</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">736</span> </span><span class="WHIT">						</span><span class="NAME">extraBr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">737</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">738</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">739</span> 
<span class="line">740</span> </span><span class="WHIT">				</span><span class="NAME">brElm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.create</span><span class="PUNC">(</span><span class="STRN">&#39;br&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">741</span> </span><span class="WHIT">				</span><span class="NAME">rng.insertNode</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">742</span> 
<span class="line">743</span> </span><span class="WHIT">				</span><span class="COMM">// Rendering modes below IE8 doesn&#39;t display BR elements in PRE unless we have a \n before it</span><span class="WHIT">
<span class="line">744</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">documentMode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.doc.documentMode</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">745</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isOldIE</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">parentBlockName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;PRE&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">documentMode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">documentMode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">8</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">746</span> </span><span class="WHIT">					</span><span class="NAME">brElm.parentNode.insertBefore</span><span class="PUNC">(</span><span class="NAME">dom.doc.createTextNode</span><span class="PUNC">(</span><span class="STRN">&#39;\r&#39;</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">747</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">748</span> 
<span class="line">749</span> </span><span class="WHIT">				</span><span class="COMM">// Insert temp marker and scroll to that</span><span class="WHIT">
<span class="line">750</span> </span><span class="WHIT">				</span><span class="NAME">marker</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.create</span><span class="PUNC">(</span><span class="STRN">&#39;span&#39;</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&nbsp;&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">751</span> </span><span class="WHIT">				</span><span class="NAME">brElm.parentNode.insertBefore</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">752</span> </span><span class="WHIT">				</span><span class="NAME">selection.scrollIntoView</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">753</span> </span><span class="WHIT">				</span><span class="NAME">dom.remove</span><span class="PUNC">(</span><span class="NAME">marker</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">754</span> 
<span class="line">755</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">extraBr</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">756</span> </span><span class="WHIT">					</span><span class="NAME">rng.setStartAfter</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">757</span> </span><span class="WHIT">					</span><span class="NAME">rng.setEndAfter</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">758</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">759</span> </span><span class="WHIT">					</span><span class="NAME">rng.setStartBefore</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">760</span> </span><span class="WHIT">					</span><span class="NAME">rng.setEndBefore</span><span class="PUNC">(</span><span class="NAME">brElm</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">761</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">762</span> 
<span class="line">763</span> </span><span class="WHIT">				</span><span class="NAME">selection.setRng</span><span class="PUNC">(</span><span class="NAME">rng</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">764</span> </span><span class="WHIT">				</span><span class="NAME">editor.undoManager.add</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">765</span> 
<span class="line">766</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">767</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">768</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">769</span> 
<span class="line">770</span> </span><span class="WHIT">		</span><span class="COMM">// Add queryCommandState overrides</span><span class="WHIT">
<span class="line">771</span> </span><span class="WHIT">		</span><span class="NAME">addCommands</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">772</span> </span><span class="WHIT">			</span><span class="COMM">// Override justify commands</span><span class="WHIT">
<span class="line">773</span> </span><span class="WHIT">			</span><span class="STRN">&#39;JustifyLeft,JustifyCenter,JustifyRight,JustifyFull&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">774</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">&#39;align&#39;</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">command.substring</span><span class="PUNC">(</span><span class="NUMB">7</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">775</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">selection.isCollapsed</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">selection.getSelectedBlocks</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">776</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">matches</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">map</span><span class="PUNC">(</span><span class="NAME">nodes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">777</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">formatter.matchNode</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">778</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">779</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">inArray</span><span class="PUNC">(</span><span class="NAME">matches</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">780</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">781</span> 
<span class="line">782</span> </span><span class="WHIT">			</span><span class="STRN">&#39;Bold,Italic,Underline,Strikethrough,Superscript,Subscript&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">783</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">isFormatMatch</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">784</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">785</span> 
<span class="line">786</span> </span><span class="WHIT">			</span><span class="NAME">mceBlockQuote</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">787</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">isFormatMatch</span><span class="PUNC">(</span><span class="STRN">&#39;blockquote&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">788</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">789</span> 
<span class="line">790</span> </span><span class="WHIT">			</span><span class="NAME">Outdent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">791</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">792</span> 
<span class="line">793</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">settings.inline_styles</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">794</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getStart</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">node.style.paddingLeft</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">795</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">796</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">797</span> 
<span class="line">798</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getEnd</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dom.isBlock</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">node.style.paddingLeft</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&gt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">799</span> </span><span class="WHIT">						</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">TRUE</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">800</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">801</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">802</span> 
<span class="line">803</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT">
<span class="line">804</span> </span><span class="WHIT">					</span><span class="NAME">queryCommandState</span><span class="PUNC">(</span><span class="STRN">&#39;InsertUnorderedList&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">805</span> </span><span class="WHIT">					</span><span class="NAME">queryCommandState</span><span class="PUNC">(</span><span class="STRN">&#39;InsertOrderedList&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">806</span> </span><span class="WHIT">					</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">settings.inline_styles</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;BLOCKQUOTE&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class="line">807</span> </span><span class="WHIT">				</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">808</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">809</span> 
<span class="line">810</span> </span><span class="WHIT">			</span><span class="STRN">&#39;InsertUnorderedList,InsertOrderedList&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">811</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">list</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;ul,ol&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">812</span> 
<span class="line">813</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">list</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT">
<span class="line">814</span> </span><span class="WHIT">					</span><span class="PUNC">(</span><span class="WHIT">
<span class="line">815</span> </span><span class="WHIT">						</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;insertunorderedlist&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">list.tagName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;UL&#39;</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class="line">816</span> </span><span class="WHIT">						</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;insertorderedlist&#39;</span><span class="WHIT"> </span><span class="PUNC">&amp;&amp;</span><span class="WHIT"> </span><span class="NAME">list.tagName</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">&#39;OL&#39;</span><span class="WHIT">
<span class="line">817</span> </span><span class="WHIT">					</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">818</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">819</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;state&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">820</span> 
<span class="line">821</span> </span><span class="WHIT">		</span><span class="COMM">// Add queryCommandValue overrides</span><span class="WHIT">
<span class="line">822</span> </span><span class="WHIT">		</span><span class="NAME">addCommands</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">823</span> </span><span class="WHIT">			</span><span class="STRN">&#39;FontSize,FontName&#39;</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">command</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">824</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">825</span> 
<span class="line">826</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dom.getParent</span><span class="PUNC">(</span><span class="NAME">selection.getNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;span&#39;</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">827</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">command</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">&#39;fontsize&#39;</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">828</span> </span><span class="WHIT">						</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parent.style.fontSize</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">829</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">830</span> </span><span class="WHIT">						</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parent.style.fontFamily.replace</span><span class="PUNC">(</span><span class="REGX">/, /g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;,&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/[\&#39;\&#34;]/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;&#39;</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">831</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">832</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">833</span> 
<span class="line">834</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">835</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">836</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">&#39;value&#39;</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">837</span> 
<span class="line">838</span> </span><span class="WHIT">		</span><span class="COMM">// Add undo manager logic</span><span class="WHIT">
<span class="line">839</span> </span><span class="WHIT">		</span><span class="NAME">addCommands</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class="line">840</span> </span><span class="WHIT">			</span><span class="NAME">Undo</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">841</span> </span><span class="WHIT">				</span><span class="NAME">editor.undoManager.undo</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">842</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class="line">843</span> 
<span class="line">844</span> </span><span class="WHIT">			</span><span class="NAME">Redo</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class="line">845</span> </span><span class="WHIT">				</span><span class="NAME">editor.undoManager.redo</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">846</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class="line">847</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">848</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">849</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class="line">850</span> </span></pre></body></html>